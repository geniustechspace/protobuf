name: Publish to Buf Schema Registry

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  push:
    name: Push to Buf Schema Registry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ github.token }}

      - name: Push to Buf Schema Registry
        uses: bufbuild/buf-push-action@v1
        with:
          input: proto
          buf_token: ${{ secrets.BUF_TOKEN }}
          draft: ${{ github.ref_name != 'main' }}

  release-packages:
    name: Release Generated Packages
    runs-on: ubuntu-latest
    needs: push
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        language: [go, python, typescript]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ github.token }}

      - name: Generate code
        run: buf generate proto

      - name: Publish Go module
        if: matrix.language == 'go'
        run: |
          cd gen/go
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Generated code for ${{ github.ref_name }}"
          git tag ${{ github.ref_name }}
          # Push to separate repository for Go module
          # git remote add origin https://github.com/geniustechspace/protobuf-go.git
          # git push -u origin main --tags

      - name: Publish Python package
        if: matrix.language == 'python'
        run: |
          cd gen/python
          # Create setup.py and publish to PyPI
          echo "Python package publishing (configure with PyPI secrets)"

      - name: Publish TypeScript package
        if: matrix.language == 'typescript'
        run: |
          cd gen/typescript
          # Create package.json and publish to npm
          echo "TypeScript package publishing (configure with NPM secrets)"

  notify:
    name: Notify on Release
    runs-on: ubuntu-latest
    needs: [push, release-packages]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Send notification
        run: |
          echo "Schema version ${{ github.ref_name }} published successfully"
          # Add Slack/email notification here if needed
