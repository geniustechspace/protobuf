name: Buf CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  buf:
    name: Buf Lint, Format, and Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Buf Lint, Format, and Breaking
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          format: true
          lint: true
          breaking: ${{ github.event_name == 'pull_request' }}
          breaking_against: 'https://github.com/${{ github.repository }}.git#branch=${{ github.base_ref || 'main' }}'
          setup_only: false
          pr_comment: true

  build:
    name: Build and Generate
    runs-on: ubuntu-latest
    needs: [buf]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Buf and Generate
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: false
          
      - name: Generate code
        run: buf generate

      - name: List generated files
        run: |
          echo "=== Generated Go files ==="
          find gen/go -name "*.go" 2>/dev/null | head -20 || echo "No Go files generated"
          echo ""
          echo "=== Generated Python files ==="
          find gen/python -name "*.py" 2>/dev/null | head -20 || echo "No Python files generated"
          echo ""
          echo "=== Generated Java files ==="
          find gen/java -name "*.java" 2>/dev/null | head -20 || echo "No Java files generated"
          echo ""
          echo "=== Generated TypeScript files ==="
          find gen/typescript -name "*.ts" 2>/dev/null | head -20 || echo "No TypeScript files generated"

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-code
          path: gen/
          retention-days: 7

  schema-list:
    name: List Proto Schemas
    runs-on: ubuntu-latest
    needs: [buf]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: true

      - name: List all proto files by domain
        run: |
          echo "# Proto Schema Inventory" > schema-list.md
          echo "" >> schema-list.md
          echo "Generated on: $(date)" >> schema-list.md
          echo "" >> schema-list.md
          
          for domain in proto/*/; do
            domain_name=$(basename "$domain")
            echo "## Domain: $domain_name" >> schema-list.md
            echo "" >> schema-list.md
            
            for version in "$domain"*/; do
              if [ -d "$version" ]; then
                version_name=$(basename "$version")
                echo "### Version: $version_name" >> schema-list.md
                echo "" >> schema-list.md
                
                for proto_file in "$version"*.proto; do
                  if [ -f "$proto_file" ]; then
                    echo "- \`$(basename "$proto_file")\`" >> schema-list.md
                    
                    # Extract services
                    services=$(grep "^service " "$proto_file" | awk '{print $2}' || true)
                    if [ -n "$services" ]; then
                      echo "  - Services: $services" >> schema-list.md
                    fi
                    
                    # Extract messages
                    messages=$(grep "^message " "$proto_file" | awk '{print $2}' | head -5 || true)
                    if [ -n "$messages" ]; then
                      echo "  - Key Messages: $(echo $messages | tr '\n' ', ' | sed 's/,$//')" >> schema-list.md
                    fi
                  fi
                done
                echo "" >> schema-list.md
              fi
            done
          done

      - name: Display schema list
        run: cat schema-list.md

      - name: Upload schema list
        uses: actions/upload-artifact@v4
        with:
          name: schema-list
          path: schema-list.md

  push-to-buf-registry:
    name: Push to Buf Schema Registry
    runs-on: ubuntu-latest
    needs: [buf, build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Push to Buf Schema Registry
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          push: true
          # To enable BSR push, add BUF_TOKEN to GitHub secrets
          # buf_token: ${{ secrets.BUF_TOKEN }}

  generate-clients:
    name: Generate Language-Specific Clients
    runs-on: ubuntu-latest
    needs: [buf, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        domain: [core, auth, users, access_policy, tenants, billing, notifications]
        language: [go, python, java, typescript]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: true

      - name: Generate ${{ matrix.language }} client for ${{ matrix.domain }}
        run: |
          echo "Generating ${{ matrix.language }} client for ${{ matrix.domain }} domain"
          buf generate --template buf.gen.yaml --path proto/${{ matrix.domain }}/
          
          # Package the generated code for the specific domain and language
          mkdir -p clients/${{ matrix.domain }}/${{ matrix.language }}
          
          case "${{ matrix.language }}" in
            go)
              if [ -d "gen/go/${{ matrix.domain }}" ]; then
                cp -r gen/go/${{ matrix.domain }}/* clients/${{ matrix.domain }}/${{ matrix.language }}/
              fi
              ;;
            python)
              if [ -d "gen/python/${{ matrix.domain }}" ]; then
                cp -r gen/python/${{ matrix.domain }}/* clients/${{ matrix.domain }}/${{ matrix.language }}/
              fi
              ;;
            java)
              if [ -d "gen/java" ]; then
                find gen/java -path "*/${{ matrix.domain }}/*" -type f -exec cp --parents {} clients/${{ matrix.domain }}/${{ matrix.language }}/ \;
              fi
              ;;
            typescript)
              if [ -d "gen/typescript/${{ matrix.domain }}" ]; then
                cp -r gen/typescript/${{ matrix.domain }}/* clients/${{ matrix.domain }}/${{ matrix.language }}/
              fi
              ;;
          esac

      - name: Upload ${{ matrix.language }} client for ${{ matrix.domain }}
        uses: actions/upload-artifact@v4
        with:
          name: client-${{ matrix.domain }}-${{ matrix.language }}
          path: clients/${{ matrix.domain }}/${{ matrix.language }}/
          retention-days: 30

  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [buf]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: true

      - name: Generate documentation
        run: |
          buf generate --template buf.gen.yaml
          
          # Create a comprehensive documentation index
          cat > gen/docs/README.md << 'EOF'
          # Protobuf API Documentation
          
          This documentation is auto-generated from the protobuf definitions.
          
          ## Domains
          
          - [Core](core/v1/) - Common types and tenant context
          - [Auth](auth/v1/) - Authentication and session management
          - [Users](users/v1/) - User management
          - [Access Policy](access-policy/v1/) - Role-based access control
          - [Tenants](tenants/v1/) - Multi-tenant management
          - [Billing](billing/v1/) - Subscription and billing
          - [Notifications](notifications/v1/) - Notification system
          
          ## Versioning
          
          Each domain supports multiple versions (v1, v2, etc.) to ensure backward compatibility.
          
          ## Client Libraries
          
          Generated client libraries are available for:
          - Go
          - Python
          - Java
          - TypeScript
          - C#
          
          EOF

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: gen/docs/
          retention-days: 30

      - name: Deploy documentation to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gen/docs
          publish_branch: gh-pages
