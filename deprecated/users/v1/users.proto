// User Domain - Messages and Service
//
// Defines user management entities, requests/responses, and service operations
// for multi-tenant user lifecycle management.
//
// COMPLIANCE: SOC 2 CC6.1 (User access), GDPR Article 5 (Data principles), ISO 27001 A.9.2
// SECURITY: All operations require authentication. Tenant isolation enforced.
// PII: Contains personally identifiable information - handle per data protection regulations

syntax = "proto3";

package users.v1;

import "buf/validate/validate.proto";
import "core/v1/common.proto";
import "google/protobuf/timestamp.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Users.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/users/v1;usersv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.users.v1";

// User represents a user account with profile and security information.
// PII: Yes - Contains personal data. COMPLIANCE: GDPR Article 4(1), SOC 2 CC6.1
message User {
  // Metadata with ID, timestamps, audit trail. COMPLIANCE: SOC 2 CC6.3
  core.v1.Metadata metadata = 1;
  // Tenant ID for multi-tenant isolation. REQUIRED. COMPLIANCE: SOC 2 CC6.1
  string tenant_id = 2 [(buf.validate.field).string.min_len = 1];
  // Email address. REQUIRED, unique per tenant. PII: Yes - GDPR Article 4(1)
  string email = 3 [(buf.validate.field).string.email = true];
  // Username for login. REQUIRED, 3-50 chars, alphanumeric+underscore/hyphen
  string username = 4 [(buf.validate.field).string = {
    min_len: 3
    max_len: 50
    pattern: "^[a-zA-Z0-9_-]+$"
  }];
  // First name. REQUIRED, 1-100 chars. PII: Yes
  string first_name = 5 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];
  // Last name. REQUIRED, 1-100 chars. PII: Yes
  string last_name = 6 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];
  // Phone number. Optional. PII: Yes
  string phone = 7;
  // Avatar/profile picture URL. Optional, must be valid URI
  string avatar_url = 8 [(buf.validate.field).string.uri = true];
  // Account status. COMPLIANCE: SOC 2 CC6.2 (Access termination)
  UserStatus status = 9 [(buf.validate.field).enum.defined_only = true];
  // Assigned roles for RBAC. COMPLIANCE: SOC 2 CC6.1
  repeated string roles = 10;
  // User preferences and settings. COMPLIANCE: GDPR Article 7 (Consent)
  UserPreferences preferences = 11;
  // Last successful login timestamp. COMPLIANCE: SOC 2 CC6.8 (Monitoring)
  google.protobuf.Timestamp last_login_at = 12;
  // Email verification status. COMPLIANCE: SOC 2 CC6.1 (Identity verification)
  bool email_verified = 13;
  // Phone verification status for MFA
  bool phone_verified = 14;
}

// UserStatus defines user account states for lifecycle management.
// COMPLIANCE: SOC 2 CC6.2 (Access management)
enum UserStatus {
  // Invalid/unspecified status
  USER_STATUS_UNSPECIFIED = 0;
  // Active user with full access. COMPLIANCE: Normal operational state
  USER_STATUS_ACTIVE = 1;
  // Inactive after inactivity period. COMPLIANCE: SOC 2 CC6.2
  USER_STATUS_INACTIVE = 2;
  // Suspended due to security/policy. COMPLIANCE: SOC 2 CC6.2 (Access termination)
  USER_STATUS_SUSPENDED = 3;
  // Pending email verification. Limited access until verified
  USER_STATUS_PENDING_VERIFICATION = 4;
}

// UserPreferences stores user-specific settings and notification preferences.
// COMPLIANCE: GDPR Article 7 (Consent), CAN-SPAM (Email opt-out), TCPA (SMS consent)
message UserPreferences {
  // Language code (ISO 639-1). Example: "en", "es". Default: "en"
  string language = 1;
  // Timezone (IANA). Example: "America/New_York". Default: system timezone
  string timezone = 2;
  // Date format preference. Example: "MM/DD/YYYY", "DD/MM/YYYY"
  string date_format = 3;
  // Time format preference. "12h" or "24h"
  string time_format = 4;
  // Master notification toggle. COMPLIANCE: GDPR Article 21 (Right to object)
  bool notifications_enabled = 5;
  // Email notification consent. COMPLIANCE: CAN-SPAM Act
  bool email_notifications = 6;
  // SMS notification consent. COMPLIANCE: TCPA (Prior express consent)
  bool sms_notifications = 7;
  // Custom application-specific preferences
  map<string, string> custom_preferences = 8;
}

// CreateUserRequest creates a new user account.
// COMPLIANCE: SOC 2 CC6.1 (User provisioning), GDPR Article 6 (Lawful processing)
message CreateUserRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1 [(buf.validate.field).string.min_len = 1];
  // Email. REQUIRED, must be unique. PII: Yes
  string email = 2 [(buf.validate.field).string.email = true];
  // Username. REQUIRED, 3-50 chars, alphanumeric+underscore/hyphen
  string username = 3 [(buf.validate.field).string = {
    min_len: 3
    max_len: 50
    pattern: "^[a-zA-Z0-9_-]+$"
  }];
  // Password. REQUIRED, min 8 chars. SECURITY: Never logged, hashed with bcrypt
  string password = 4 [(buf.validate.field).string.min_len = 8];
  // First name. REQUIRED, 1-100 chars
  string first_name = 5 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];
  // Last name. REQUIRED, 1-100 chars
  string last_name = 6 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];
  // Phone. Optional
  string phone = 7;
  // Initial roles. Optional
  repeated string roles = 8;
}

// CreateUserResponse returns newly created user.
message CreateUserResponse {
  // Created user with assigned ID
  User user = 1;
}

// GetUserRequest retrieves a user by ID.
message GetUserRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1;
  // User ID to retrieve. REQUIRED
  string user_id = 2;
}

// GetUserResponse returns requested user.
message GetUserResponse {
  // Retrieved user. Null if not found
  User user = 1;
}

// UpdateUserRequest updates user profile information. Partial update supported.
// COMPLIANCE: GDPR Article 16 (Right to rectification)
message UpdateUserRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1;
  // User ID to update. REQUIRED
  string user_id = 2;
  // Email. Optional, must be unique if provided
  string email = 3;
  // Username. Optional
  string username = 4;
  // First name. Optional
  string first_name = 5;
  // Last name. Optional
  string last_name = 6;
  // Phone. Optional
  string phone = 7;
  // Avatar URL. Optional
  string avatar_url = 8;
  // Preferences. Optional
  UserPreferences preferences = 9;
}

// UpdateUserResponse returns updated user.
message UpdateUserResponse {
  // Updated user with new values
  User user = 1;
}

// DeleteUserRequest soft-deletes a user account.
// COMPLIANCE: GDPR Article 17 (Right to erasure), SOC 2 CC6.2 (Deprovisioning)
message DeleteUserRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1;
  // User ID to delete. REQUIRED
  string user_id = 2;
}

// DeleteUserResponse confirms deletion.
message DeleteUserResponse {
  // True if deleted successfully
  bool success = 1;
}

// ListUsersRequest retrieves paginated list of users with optional filtering.
message ListUsersRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1;
  // Pagination parameters. Optional, defaults to page 0, size 20
  core.v1.PaginationRequest pagination = 2;
  // Filter by status. Optional
  UserStatus status = 3;
  // Filter by roles. Optional
  repeated string roles = 4;
  // Search in email, username, name. Optional
  string search_query = 5;
}

// ListUsersResponse returns paginated list of users.
message ListUsersResponse {
  // List of users matching filters
  repeated User users = 1;
  // Pagination metadata
  core.v1.PaginationResponse pagination = 2;
}

// ChangePasswordRequest changes user password. Self-service only.
// COMPLIANCE: NIST 800-63B (Password security), SOC 2 CC6.1
message ChangePasswordRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1;
  // User ID. REQUIRED (must match authenticated user)
  string user_id = 2;
  // Current password for verification. REQUIRED. SECURITY: Not logged
  string current_password = 3;
  // New password. REQUIRED, min 8 chars. SECURITY: Hashed with bcrypt
  string new_password = 4;
}

// ChangePasswordResponse confirms password change.
message ChangePasswordResponse {
  // True if password changed successfully
  bool success = 1;
}

// UpdateUserStatusRequest changes user account status.
// COMPLIANCE: SOC 2 CC6.2 (Access termination/suspension), ISO 27001 A.9.2.6
message UpdateUserStatusRequest {
  // Tenant ID. REQUIRED
  string tenant_id = 1;
  // User ID. REQUIRED
  string user_id = 2;
  // New status. REQUIRED
  UserStatus status = 3;
  // Reason for status change. REQUIRED for SUSPENDED status. AUDIT: Logged
  string reason = 4;
}

// UpdateUserStatusResponse returns user with updated status.
message UpdateUserStatusResponse {
  // User with new status
  User user = 1;
}

// UserService provides comprehensive user management operations.
// COMPLIANCE: SOC 2 CC6.1 (Access controls), ISO 27001 A.9.2 (User access management)
// AUTHENTICATION: All RPCs require valid authentication token
// AUTHORIZATION: Operations enforce role-based permissions and tenant isolation
service UserService {
  // CreateUser creates new user account. Requires 'users:create' permission or admin role.
  // COMPLIANCE: SOC 2 CC6.1 (User provisioning)
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);

  // GetUser retrieves user by ID. Requires 'users:read' permission or self-access.
  // COMPLIANCE: GDPR Article 15 (Right of access)
  rpc GetUser(GetUserRequest) returns (GetUserResponse);

  // UpdateUser updates user profile. Requires 'users:update' permission, admin role, or self-update.
  // COMPLIANCE: GDPR Article 16 (Right to rectification)
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);

  // DeleteUser soft-deletes user account. Requires 'users:delete' permission or admin role.
  // COMPLIANCE: GDPR Article 17 (Right to erasure), SOC 2 CC6.2 (Deprovisioning)
  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse);

  // ListUsers returns paginated filtered user list. Requires 'users:list' permission.
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);

  // ChangePassword changes user password. Self-service only (users change own password).
  // COMPLIANCE: NIST 800-63B, SOC 2 CC6.1. SECURITY: Rate limited 5/hour
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse);

  // UpdateUserStatus changes account status. Requires 'users:update_status' or admin role.
  // COMPLIANCE: SOC 2 CC6.2 (Access termination), ISO 27001 A.9.2.6
  rpc UpdateUserStatus(UpdateUserStatusRequest) returns (UpdateUserStatusResponse);
}
