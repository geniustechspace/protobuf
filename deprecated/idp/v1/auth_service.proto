// IDP Authentication Service - Version 1
// Core authentication operations (login, MFA, logout)
//
// COMPLIANCE:
//   - OAuth 2.0 (RFC 6749): Authorization Framework
//   - OpenID Connect Core 1.0: Identity layer on OAuth 2.0
//   - NIST 800-63B: Digital Identity Guidelines (AAL1-3)
//   - OWASP Top 10: Authentication security controls
//   - PCI DSS 3.2.1: Strong authentication requirements
//   - GDPR Article 32: Security of processing
//
// SECURITY:
//   - TLS 1.3+ required for all transport
//   - Rate limiting: 5 attempts/min per IP, 10/min per user
//   - MFA rate limiting: 3 attempts per 5min per session
//   - Audit logging mandatory for all operations
//   - No sensitive data in logs (passwords, tokens masked)
//   - Session binding (device/client verification)
//
// RATE LIMITS:
//   - StartAuthentication: 10/min per IP
//   - Authentication: 5/min per IP, 10/min per user
//   - VerifyMFA: 3 attempts per 5min per session
//   - Logout: 10/min per session

syntax = "proto3";

package geniustechspace.idp.v1;

import "proto/idp/v1/authentication.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Idp.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/idp/v1;idpv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.idp.v1";

// AuthenticationService handles core authentication flows
//
// RESPONSIBILITY: User authentication, MFA verification, session termination
//
// ARCHITECTURE:
//   - Stateless operations (session state in external store)
//   - Idempotent where possible
//   - Returns uniform AuthenticationResponse for consistency
//
// FLOWS:
//   1. Simple auth: Authentication → SUCCESS
//   2. MFA auth: Authentication → MFA_REQUIRED → VerifyMFA → SUCCESS
//   3. Passwordless: StartAuthentication → (out-of-band) → Authentication → SUCCESS
service AuthenticationService {
  // StartAuthentication: Initiates passwordless authentication flows
  // 
  // Use cases:
  //   - Magic link generation (email/SMS)
  //   - WebAuthn ceremony initiation
  //   - User existence check (for progressive profiling)
  //
  // Returns: AuthenticationResponse with status and challenge
  // Rate limit: 10/min per IP
  // Auth required: No
  rpc StartAuthentication(StartAuthenticationRequest) returns (AuthenticationResponse);
  
  // Authentication: Primary authentication with credentials
  //
  // Supported methods:
  //   - Password, OTP, TOTP
  //   - Social (OAuth 2.0 / OIDC)
  //   - SAML 2.0 SSO
  //   - WebAuthn / FIDO2
  //   - Biometric (device-bound)
  //   - Client certificate (mTLS)
  //
  // Returns: 
  //   - SUCCESS: Full authentication complete (tokens + session)
  //   - MFA_REQUIRED: Additional factor needed (call VerifyMFA)
  //   - FAILED/INVALID_CREDENTIALS: Authentication failed
  //   - RATE_LIMITED/ACCOUNT_LOCKED: Security block
  //
  // Rate limit: 5/min per IP, 10/min per user
  // Auth required: No
  rpc Authentication(AuthenticationRequest) returns (AuthenticationResponse);
  
  // VerifyMFA: Second-factor verification for MFA flows
  //
  // Call after receiving MFA_REQUIRED from Authentication.
  // Uses temporary MFA session from initial authentication response.
  //
  // Supported factors:
  //   - TOTP (authenticator app)
  //   - SMS OTP, Email OTP
  //   - WebAuthn security key
  //   - Biometric verification
  //   - Push notification approval
  //   - Backup recovery codes
  //
  // Returns: Same structure as Authentication
  //   - SUCCESS: MFA complete (tokens + upgraded session)
  //   - FAILED: Invalid MFA code
  //   - RATE_LIMITED: Too many attempts
  //
  // Rate limit: 3 attempts per 5min per session
  // Auth required: Temporary MFA session (from Authentication response)
  rpc VerifyMFA(VerifyMFARequest) returns (AuthenticationResponse);
  
  // Logout: Terminates session and revokes all associated tokens
  //
  // Actions:
  //   - Invalidate session
  //   - Revoke access + refresh tokens
  //   - Clear server-side session cache
  //   - Log audit event
  //
  // Rate limit: 10/min per session
  // Auth required: Yes (valid session token)
  rpc Logout(LogoutRequest) returns (LogoutResponse);
}
