// IDP Authentication - Version 1
// Enterprise-standard flat design for simple, efficient authentication
//
// COMPLIANCE:
//   - OAuth 2.0: RFC 6749 (Authorization Framework)
//   - OpenID Connect Core 1.0
//   - RFC 7519 (JWT)
//   - NIST 800-63B (Digital Identity Guidelines)
//   - GDPR Article 32 (Security of Processing)
//
// SECURITY:
//   - Contains PII (email, phone) - encrypt in transit (TLS 1.3+)
//   - Passwords never logged - use secure hashing (bcrypt/argon2)
//   - Rate limiting required - implement exponential backoff
//   - Audit logging mandatory - log all authentication attempts
//
// PRIVACY:
//   - PII fields: email, phone, username
//   - Data retention: Follow tenant-specific policies
//   - Right to erasure: Support GDPR deletion requests

syntax = "proto3";

package geniustechspace.idp.v1;

import "buf/validate/validate.proto";
import "proto/datastructure/v1/session/messages.proto";
import "proto/idp/v1/enums.proto";
import "proto/idp/v1/tokens.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Idp.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/idp/v1;idpv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.idp.v1";


// StartAuthenticationRequest - FLAT DESIGN
// Initiates authentication flow without credentials (for passwordless flows)
//
// Use cases:
//   - Magic link request (returns challenge)
//   - WebAuthn initiation (returns challenge)
//   - Check if user exists (for progressive profiling)
//
// SECURITY: This endpoint may be used for user enumeration attacks.
//           Implement rate limiting and return consistent responses.
message StartAuthenticationRequest {
  reserved 6 to 9, 10 to 19;

  // Tenant ID (required for multi-tenant)
  string tenant_id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
    ignore_empty: true
  }];

  // ========== IDENTITY (one required) ==========
  // PII WARNING: email, phone, username contain personally identifiable information
  oneof identifier {
    string username = 2 [(buf.validate.field).string = {
      min_len: 3
      max_len: 64
      pattern: "^[a-zA-Z0-9._-]+$"
    }];
    string email = 3 [(buf.validate.field).string = {
      email: true
      max_len: 254
    }];
    string phone = 4 [(buf.validate.field).string = {
      pattern: "^\\+[1-9]\\d{1,14}$"  // E.164 format
      max_len: 16
    }];
    string user_id = 5 [(buf.validate.field).string = {
      min_len: 1
      max_len: 128
    }];
  }
}

// AuthenticationRequest - FLAT DESIGN
// Primary authentication with credentials
//
// SECURITY REQUIREMENTS:
//   - TLS 1.3+ required for transport
//   - Password field never logged
//   - Rate limiting: 5 attempts per minute per IP
//   - Account lockout: 10 failed attempts = 30min lockout
//   - Session binding: Verify IP/User-Agent consistency
//
// COMPLIANCE:
//   - NIST 800-63B: Credential strength requirements
//   - PCI DSS 3.2.1: If processing payment data
//   - SOC 2 Type II: Audit trail required
message AuthenticationRequest {
  reserved 7 to 9, 20 to 28, 35 to 39, 50 to 99;

  // Tenant ID (required for multi-tenant isolation)
  // MUST be validated against authenticated tenant context
  string tenant_id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
    ignore_empty: true
  }];

  // ========== IDENTITY (one required) ==========
  // PII WARNING: Contains personally identifiable information
  // GDPR: Process under legitimate interest or consent
  oneof identifier {
    string username = 2 [(buf.validate.field).string = {
      min_len: 3
      max_len: 64
      pattern: "^[a-zA-Z0-9._-]+$"
    }];
    string email = 3 [(buf.validate.field).string = {
      email: true
      max_len: 254  // RFC 5321
    }];
    string phone = 4 [(buf.validate.field).string = {
      pattern: "^\\+[1-9]\\d{1,14}$"  // E.164 international format
      max_len: 16
    }];
    string user_id = 5 [(buf.validate.field).string = {
      min_len: 1
      max_len: 128
    }];
    // Session ID from StartAuthenticationRequest response
    string session_id = 6 [(buf.validate.field).string = {
      min_len: 8
      max_len: 128
    }];
  }

  // ========== CREDENTIALS (one required) ==========
  // SECURITY: Never log credential values - hash passwords with bcrypt/argon2
  // COMPLIANCE: NIST 800-63B password requirements
  oneof credential {
    string password = 10 [(buf.validate.field).string = {
      min_len: 8        // NIST 800-63B minimum
      max_len: 128      // Prevent DoS attacks
    }];
    string otp_code = 11 [(buf.validate.field).string = {
      pattern: "^[0-9]{6}$"  // 6-digit numeric
    }];
    string totp_code = 12 [(buf.validate.field).string = {
      pattern: "^[0-9]{6}$"  // RFC 6238 TOTP
    }];
    string magic_link_token = 13 [(buf.validate.field).string = {
      min_len: 32
      max_len: 256
    }];
    string social_id_token = 14 [(buf.validate.field).string = {
      min_len: 1        // OAuth 2.0 ID Token (JWT)
      max_len: 4096     // Typical JWT max size
    }];
    string saml_assertion = 15 [(buf.validate.field).string = {
      min_len: 1        // SAML 2.0 assertion (XML)
      max_len: 100000   // Large XML documents
    }];
    WebAuthnAssertion webauthn = 16;          // WebAuthn/FIDO2 (W3C standard)
    BiometricAssertion biometric = 17;        // ISO/IEC 19794 biometric data
    string backup_code = 18 [(buf.validate.field).string = {
      min_len: 8
      max_len: 32
    }];
    ClientCertificate certificate = 19;       // X.509 mTLS (RFC 5280)
  }

  // Social provider (required when using social_id_token)
  // Validates OAuth 2.0 / OpenID Connect tokens
  SocialProvider social_provider = 29;


  // ========== OAUTH/OIDC OPTIONS ==========
  // COMPLIANCE: RFC 6749 (OAuth 2.0), OpenID Connect Core 1.0
  repeated string scopes = 30 [(buf.validate.field).repeated = {
    max_items: 20
    items: {
      string: {
        min_len: 1
        max_len: 64
        pattern: "^[a-z0-9:._-]+$"
      }
    }
  }];
  string client_secret = 31 [(buf.validate.field).string = {
    min_len: 1
    max_len: 256
    ignore_empty: true
  }];  // SECURITY: Use for confidential clients only
  string nonce = 32 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
    ignore_empty: true
  }];  // OIDC: Prevents replay attacks (min 128 bits entropy)
  string state = 33 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
    ignore_empty: true
  }];  // OAuth 2.0: CSRF protection (min 128 bits entropy)
  string redirect_uri = 34 [(buf.validate.field).string = {
    uri: true
    max_len: 2048
    ignore_empty: true
  }];  // MUST be pre-registered (RFC 6749 Section 3.1.2)

  // ========== SESSION OPTIONS ==========
  // COMPLIANCE: OWASP Session Management Cheat Sheet
  bool remember_session = 40;                 // Extends session beyond browser close
  int64 session_duration = 41 [(buf.validate.field).int64 = {
    gte: 60           // Minimum 1 minute
    lte: 2592000      // Maximum 30 days (OWASP recommendation)
    ignore_empty: true
  }];  // Custom duration in seconds
}

// Complex credential types (only when needed - flat, simple)

// WebAuthnAssertion - W3C WebAuthn Level 2 compliant
// COMPLIANCE: FIDO2 CTAP2, ISO/IEC 14888 (Digital signatures)
// SECURITY: Phishing-resistant, replay-resistant
message WebAuthnAssertion {
  string credential_id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 1024
  }];
  bytes authenticator_data = 2 [(buf.validate.field).bytes = {
    min_len: 37       // Minimum authenticator data size
    max_len: 1024
  }];
  bytes client_data_json = 3 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 1024
  }];
  bytes signature = 4 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 1024
  }];
  bytes user_handle = 5 [(buf.validate.field).bytes = {
    max_len: 64
    ignore_empty: true
  }];  // Optional for usernameless flow
}

// BiometricAssertion - ISO/IEC 19794 biometric data formats
// SECURITY: Biometric templates should be encrypted and never stored in plaintext
// PRIVACY: High-risk PII - requires explicit consent (GDPR Article 9)
message BiometricAssertion {
  BiometricType type = 1;
  bytes biometric_data = 2 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 102400   // 100KB max for biometric template
  }];  // Encrypted biometric template
  string device_attestation = 3 [(buf.validate.field).string = {
    max_len: 4096
    ignore_empty: true
  }];  // Device attestation JWT
}

// ClientCertificate - X.509 mTLS authentication
// COMPLIANCE: RFC 5280 (X.509), RFC 8446 (TLS 1.3)
// SECURITY: Certificate validation required (CRL/OCSP)
message ClientCertificate {
  bytes certificate = 1 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 10240    // 10KB max for certificate chain
  }];  // X.509 certificate (DER encoded)
  bytes signature = 2 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 1024
  }];  // Signature over challenge
}

// AuthenticationResponse - FLAT, simple
// Returns authentication result with tokens and session
//
// SECURITY:
//   - Tokens contain sensitive data - use HTTPS only
//   - Log successful/failed attempts for audit
//   - Include security headers (X-Content-Type-Options, etc.)
//
// COMPLIANCE:
//   - PCI DSS: Log authentication events
//   - SOC 2: Audit trail for access control
//   - GDPR: Log basis for processing (legitimate interest/consent)
message AuthenticationResponse {
  reserved 5 to 9, 12 to 19;

  // Authentication result status
  AuthenticationStatus status = 1;
  
  // User ID (only on success or MFA_REQUIRED)
  // PRIVACY: Contains user identifier - handle per data retention policy
  string user_id = 2 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];
  
  // Authentication tokens (only on success)
  // SECURITY: Short-lived access tokens (15min), rotate refresh tokens
  AuthTokenSet tokens = 3;
  
  // Session information (on success or MFA_REQUIRED)
  // Contains session ID, device, client context for tracking
  geniustechspace.datastructure.v1.session.Session session = 4;

  // User-facing message (localized via message_key)
  string message = 10 [(buf.validate.field).string = {
    max_len: 500
    ignore_empty: true
  }];
  
  // Message localization key (e.g., "auth.success", "auth.mfa_required")
  string message_key = 11 [(buf.validate.field).string = {
    max_len: 100
    pattern: "^[a-z._]+$"
    ignore_empty: true
  }];
}

// VerifyMFARequest - FLAT
// Second-factor verification for MFA flows
//
// SECURITY:
//   - Rate limiting: 3 attempts per 5 minutes
//   - Temporary session expires in 5 minutes
//   - Log all MFA attempts (success/failure)
//
// COMPLIANCE:
//   - NIST 800-63B: Authenticator assurance levels
//   - PSD2: Strong Customer Authentication (SCA)
message VerifyMFARequest {
  reserved 8 to 9, 20 to 30;
  
  // Temporary MFA session ID from AuthenticationResponse
  // SECURITY: Single-use, expires in 5 minutes
  string session_id = 1 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
  }];
  
  // Tenant ID (must match initial authentication request)
  string tenant_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];
  
  // MFA credential (flat, direct)
  // SECURITY: Never log these values - single-use codes
  oneof credential {
    string otp_code = 10 [(buf.validate.field).string = {
      pattern: "^[0-9]{6}$"
    }];  // SMS/Email OTP (6-digit)
    string totp_code = 11 [(buf.validate.field).string = {
      pattern: "^[0-9]{6}$"
    }];  // RFC 6238 TOTP (30-second window)
    string backup_code = 12 [(buf.validate.field).string = {
      min_len: 8
      max_len: 32
    }];  // Recovery code (single-use)
    WebAuthnAssertion webauthn = 13;          // FIDO2 second factor
    BiometricAssertion biometric = 14;        // Biometric second factor
    string push_token = 15 [(buf.validate.field).string = {
      min_len: 8
      max_len: 256
      ignore_empty: true
    }];  // Push notification approval token
  }
}

// LogoutRequest - FLAT
// Terminates user session and revokes tokens
//
// SECURITY:
//   - Revoke all associated tokens
//   - Clear session from cache/database
//   - Log logout event for audit
//
// COMPLIANCE:
//   - OWASP: Explicit logout mechanism required
//   - SOC 2: Audit trail for session termination
message LogoutRequest {
  reserved 3 to 30;
  
  // Session ID to terminate
  string session_id = 1 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
  }];
  
  // Tenant ID (must match session tenant)
  string tenant_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];
}

// LogoutResponse - FLAT
// Confirms session termination
//
// SECURITY: Tokens revoked, session invalidated
message LogoutResponse {
  reserved 3 to 10;
  
  // Success flag
  bool success = 1;
  
  // User-facing message
  string message = 2 [(buf.validate.field).string = {
    max_len: 200
    ignore_empty: true
  }];
}

