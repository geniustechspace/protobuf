// IDP Audit Messages - Version 1
// Comprehensive audit logging for authentication and authorization
//
// COMPLIANCE:
//   - SOC 2 Type II (Audit trail requirements)
//   - PCI DSS 10.2 (Audit log requirements)
//   - GDPR Article 30 (Records of processing activities)
//   - HIPAA 164.312(b) (Audit controls)
//   - ISO 27001 A.12.4.1 (Event logging)
//
// SECURITY:
//   - Immutable logs (append-only)
//   - Tamper detection (cryptographic hashing)
//   - Retention: 13 months minimum (PCI DSS), 7 years recommended
//   - Secure storage: Encrypted at rest
//
// PRIVACY:
//   - Contains PII (user_id, email, IP address)
//   - Pseudonymization for analytics
//   - Access control: Security team only

syntax = "proto3";

package geniustechspace.idp.v1.audit;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "proto/idp/v1/audit/enums.proto";
import "proto/datastructure/v1/session/enums.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Idp.V1.Audit";
option go_package = "github.com/geniustechspace/protobuf/gen/go/idp/v1/audit;audit";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.idp.v1.audit";

// ========== AUDIT EVENT ==========

// AuditEvent - Base audit event structure
// COMPLIANCE: Follows SOC 2 and PCI DSS audit trail requirements
message AuditEvent {
  reserved 30 to 50;

  // ========== IDENTIFIERS ==========
  
  // Unique event ID (UUID v4)
  string event_id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Tenant ID
  string tenant_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Correlation ID (for tracing related events)
  string correlation_id = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 128
    ignore_empty: true
  }];

  // Parent event ID (for nested operations)
  string parent_event_id = 4 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
    ignore_empty: true
  }];

  // ========== EVENT CLASSIFICATION ==========

  // Event category
  AuditCategory category = 5;

  // Event type (specific action within category)
  // Examples: "login_success", "login_failed", "mfa_required", "password_reset"
  string event_type = 6 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Event severity
  AuditSeverity severity = 7;

  // ========== ACTOR INFORMATION ==========
  // PII WARNING: Contains user identifiers

  // Actor (who performed the action)
  oneof actor {
    string user_id = 8 [(buf.validate.field).string = {
      min_len: 1
      max_len: 128
    }];
    string agent_id = 9 [(buf.validate.field).string = {
      min_len: 1
      max_len: 128
    }];
    string system_id = 10 [(buf.validate.field).string = {
      min_len: 1
      max_len: 128
    }];
  }

  // Actor username (for display)
  string actor_username = 11 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // Actor email (for display)
  string actor_email = 12 [(buf.validate.field).string = {
    email: true
    max_len: 254
    ignore_empty: true
  }];

  // ========== CONTEXT INFORMATION ==========

  // Session ID (if applicable)
  string session_id = 13 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // Device ID
  string device_id = 14 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // Client ID (application)
  string client_id = 15 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // IP address (PII in some jurisdictions)
  string ip_address = 16 [(buf.validate.field).string = {
    max_len: 45  // IPv6 max length
    ignore_empty: true
  }];

  // User agent (browser/app identifier)
  string user_agent = 17 [(buf.validate.field).string = {
    max_len: 500
    ignore_empty: true
  }];

  // Geographic location ID
  string geo_location_id = 18 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // ========== RESOURCE INFORMATION ==========

  // Resource type (e.g., "user", "session", "token", "policy")
  string resource_type = 19 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // Resource ID
  string resource_id = 20 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // Resource name (for display)
  string resource_name = 21 [(buf.validate.field).string = {
    max_len: 255
    ignore_empty: true
  }];

  // ========== OPERATION DETAILS ==========

  // Action performed (e.g., "create", "read", "update", "delete")
  string action = 22 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // Operation result
  AuditResult result = 23;

  // Error code (if result is failure/error)
  string error_code = 24 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // Error message (if result is failure/error)
  string error_message = 25 [(buf.validate.field).string = {
    max_len: 1000
    ignore_empty: true
  }];

  // ========== AUTHENTICATION DETAILS ==========

  // Authentication method used
  geniustechspace.datastructure.v1.session.AuthenticationMethod auth_method = 26;

  // MFA type (if MFA was involved)
  geniustechspace.datastructure.v1.session.MFAType mfa_type = 27;

  // Risk score (0-100)
  int32 risk_score = 28 [(buf.validate.field).int32 = {
    gte: 0
    lte: 100
    ignore_empty: true
  }];

  // Risk level
  string risk_level = 29 [(buf.validate.field).string = {
    max_len: 32
    ignore_empty: true
  }];

  // ========== ADDITIONAL DATA ==========

  // Event-specific metadata (flexible structure)
  // SECURITY: Do NOT log sensitive data (passwords, tokens)
  google.protobuf.Struct metadata = 51;

  // Changes made (for update operations)
  // Format: {"field": {"old": "value", "new": "value"}}
  google.protobuf.Struct changes = 52;

  // Request parameters (non-sensitive only)
  google.protobuf.Struct request_params = 53;

  // Response data (summary only, not full response)
  google.protobuf.Struct response_summary = 54;

  // ========== TIMESTAMPS ==========

  // Event timestamp (when the event occurred)
  google.protobuf.Timestamp timestamp = 60;

  // Event received timestamp (when logged)
  google.protobuf.Timestamp received_at = 61;

  // Event processing duration (milliseconds)
  int64 duration_ms = 62 [(buf.validate.field).int64 = {
    gte: 0
    ignore_empty: true
  }];

  // ========== COMPLIANCE & SECURITY ==========

  // Compliance tags (e.g., "pci_dss", "gdpr", "hipaa")
  repeated string compliance_tags = 70 [(buf.validate.field).repeated.max_items = 20];

  // Security classification
  SecurityClassification classification = 71;

  // Data retention period (days)
  int32 retention_days = 72 [(buf.validate.field).int32 = {
    gte: 0
    lte: 3650  // 10 years max
    ignore_empty: true
  }];

  // Audit trail hash (for tamper detection)
  // Hash of previous event + current event content
  string audit_hash = 73 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // Digital signature (for non-repudiation)
  string signature = 74 [(buf.validate.field).string = {
    max_len: 1024
    ignore_empty: true
  }];
}

// ========== SPECIFIC AUDIT EVENTS ==========

// AuthenticationAuditEvent - Specialized for authentication events
// Extends AuditEvent with authentication-specific fields
message AuthenticationAuditEvent {
  reserved 20 to 50;

  // Base audit event
  AuditEvent base = 1;

  // Login identifier used (username, email, phone)
  string login_identifier = 2 [(buf.validate.field).string = {
    max_len: 254
    ignore_empty: true
  }];

  // Authentication status
  string auth_status = 3 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // MFA required
  bool mfa_required = 4;

  // MFA methods completed
  repeated geniustechspace.datastructure.v1.session.MFAType mfa_methods_completed = 5 [(buf.validate.field).repeated.max_items = 10];

  // New device
  bool is_new_device = 6;

  // New location
  bool is_new_location = 7;

  // Suspicious activity detected
  bool is_suspicious = 8;

  // Failed attempt count (if login failed)
  int32 failed_attempt_count = 9 [(buf.validate.field).int32 = {
    gte: 0
    ignore_empty: true
  }];

  // Account locked (if lockout triggered)
  bool account_locked = 10;

  // Tokens issued (token IDs, not actual tokens)
  repeated string token_ids = 11 [(buf.validate.field).repeated.max_items = 10];

  // Session ID created
  string session_id_created = 12 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];
}

// SessionAuditEvent - Specialized for session events
message SessionAuditEvent {
  reserved 10 to 50;

  // Base audit event
  AuditEvent base = 1;

  // Session ID
  string session_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 128
  }];

  // Session action (created, extended, revoked, expired)
  string session_action = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Session duration (seconds)
  int64 session_duration_seconds = 4 [(buf.validate.field).int64.gte = 0];

  // Session extended
  bool session_extended = 5;

  // Idle timeout
  bool idle_timeout = 6;

  // Revocation reason (if revoked)
  string revocation_reason = 7 [(buf.validate.field).string = {
    max_len: 500
    ignore_empty: true
  }];
}

// TokenAuditEvent - Specialized for token events
message TokenAuditEvent {
  reserved 10 to 50;

  // Base audit event
  AuditEvent base = 1;

  // Token ID (not the token itself)
  string token_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 128
  }];

  // Token type (access, refresh, id)
  string token_type = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Token action (issued, refreshed, revoked, introspected)
  string token_action = 4 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Token lifetime (seconds)
  int64 token_lifetime_seconds = 5 [(buf.validate.field).int64.gte = 0];

  // Scopes granted
  repeated string scopes = 6 [(buf.validate.field).repeated.max_items = 50];

  // Associated session ID
  string session_id = 7 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];
}

// AccountAuditEvent - Specialized for account lifecycle events
message AccountAuditEvent {
  reserved 10 to 50;

  // Base audit event
  AuditEvent base = 1;

  // Account ID (user_id)
  string account_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 128
  }];

  // Account action (created, updated, deleted, locked, unlocked, suspended)
  string account_action = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Previous status (if status changed)
  string previous_status = 4 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // New status (if status changed)
  string new_status = 5 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];

  // Reason for action
  string reason = 6 [(buf.validate.field).string = {
    max_len: 1000
    ignore_empty: true
  }];

  // Performed by admin
  bool performed_by_admin = 7;
}

// SecurityAuditEvent - Specialized for security events
message SecurityAuditEvent {
  reserved 10 to 50;

  // Base audit event
  AuditEvent base = 1;

  // Security event type (brute_force, credential_stuffing, anomaly, etc.)
  string security_event_type = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Threat level
  ThreatLevel threat_level = 3;

  // Attack vector
  string attack_vector = 4 [(buf.validate.field).string = {
    max_len: 255
    ignore_empty: true
  }];

  // Detection method
  string detection_method = 5 [(buf.validate.field).string = {
    max_len: 255
    ignore_empty: true
  }];

  // Mitigation action taken
  string mitigation_action = 6 [(buf.validate.field).string = {
    max_len: 500
    ignore_empty: true
  }];

  // False positive (if later determined)
  bool false_positive = 7;

  // Related events (correlation with other security events)
  repeated string related_event_ids = 8 [(buf.validate.field).repeated.max_items = 50];
}

// ========== AUDIT QUERY ==========

// AuditEventQuery - Query audit events
message AuditEventQuery {
  reserved 30 to 50;

  // Tenant ID (required)
  string tenant_id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];

  // Time range (required)
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;

  // Filters
  repeated AuditCategory categories = 4 [(buf.validate.field).repeated.max_items = 20];
  repeated string event_types = 5 [(buf.validate.field).repeated.max_items = 50];
  repeated AuditSeverity severities = 6 [(buf.validate.field).repeated.max_items = 10];
  repeated AuditResult results = 7 [(buf.validate.field).repeated.max_items = 10];

  // Actor filters
  repeated string user_ids = 8 [(buf.validate.field).repeated.max_items = 100];
  repeated string session_ids = 9 [(buf.validate.field).repeated.max_items = 100];
  repeated string device_ids = 10 [(buf.validate.field).repeated.max_items = 100];
  repeated string ip_addresses = 11 [(buf.validate.field).repeated.max_items = 100];

  // Resource filters
  string resource_type = 12 [(buf.validate.field).string = {
    max_len: 64
    ignore_empty: true
  }];
  repeated string resource_ids = 13 [(buf.validate.field).repeated.max_items = 100];

  // Pagination
  int32 page_size = 20 [(buf.validate.field).int32 = {
    gte: 1
    lte: 1000
  }];
  string page_token = 21 [(buf.validate.field).string = {
    max_len: 1000
    ignore_empty: true
  }];

  // Sort order
  SortOrder sort_order = 22;
}

// AuditEventQueryResponse - Query results
message AuditEventQueryResponse {
  reserved 10 to 50;

  // Matching events
  repeated AuditEvent events = 1;

  // Total count (may be greater than returned events)
  int64 total_count = 2;

  // Next page token
  string next_page_token = 3 [(buf.validate.field).string = {
    max_len: 1000
    ignore_empty: true
  }];

  // Query execution time (milliseconds)
  int64 execution_time_ms = 4;
}
