// IDP MFA Service - Version 1
// Multi-factor authentication enrollment and management
//
// COMPLIANCE:
//   - NIST 800-63B: Authenticator assurance levels
//   - PSD2: Strong Customer Authentication (SCA)
//   - OWASP: MFA best practices
//   - SOC 2: Multi-factor authentication controls
//
// SECURITY:
//   - TOTP: RFC 6238 compliant (30s window, SHA-256)
//   - SMS/Email OTP: Rate limited (prevent brute force)
//   - Backup codes: Single-use, securely generated
//   - Primary factor tracking (require at least one)
//   - Enrollment requires existing authentication
//
// RATE LIMITS:
//   - Begin*Enrollment: 5/hour per user
//   - Confirm*Enrollment: 10/hour per user
//   - ListMFAFactors: 20/min per user
//   - RemoveMFAFactor: 10/min per user
//   - GenerateBackupCodes: 3/day per user

syntax = "proto3";

package geniustechspace.idp.v1;

import "proto/idp/v1/mfa.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Idp.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/idp/v1;idpv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.idp.v1";

// MFAService handles multi-factor authentication lifecycle
//
// RESPONSIBILITY: MFA enrollment, factor management, backup codes
//
// ARCHITECTURE:
//   - Two-phase enrollment (begin â†’ confirm with code)
//   - Multiple factors per user (TOTP + SMS + WebAuthn)
//   - Primary factor designation (fallback if one fails)
//   - Backup codes for recovery
//
// SUPPORTED FACTORS:
//   - TOTP (authenticator apps: Google Authenticator, Authy)
//   - SMS OTP (text message codes)
//   - Email OTP (email codes)
//   - WebAuthn (security keys: YubiKey, etc.) - see WebAuthnService
//   - Push notifications (mobile app approval)
//   - Backup codes (single-use recovery)
service MFAService {
  // ===== TOTP Enrollment =====
  
  // BeginTOTPEnrollment: Starts TOTP setup
  //
  // Returns QR code and secret for authenticator app.
  // User scans QR code in Google Authenticator, Authy, etc.
  //
  // Rate limit: 5/hour per user
  // Auth required: Yes (user must be authenticated)
  rpc BeginTOTPEnrollment(BeginTOTPEnrollmentRequest) returns (BeginTOTPEnrollmentResponse);
  
  // ConfirmTOTPEnrollment: Completes TOTP setup
  //
  // Validates first TOTP code to ensure working.
  // Stores TOTP secret for future verification.
  //
  // Rate limit: 10/hour per user
  // Auth required: Yes (same session as BeginTOTPEnrollment)
  rpc ConfirmTOTPEnrollment(ConfirmTOTPEnrollmentRequest) returns (ConfirmTOTPEnrollmentResponse);
  
  // ===== SMS Enrollment =====
  
  // BeginSMSEnrollment: Starts SMS OTP setup
  //
  // Sends verification code to phone number.
  //
  // Rate limit: 5/hour per user (prevent SMS bombing)
  // Auth required: Yes
  rpc BeginSMSEnrollment(BeginSMSEnrollmentRequest) returns (BeginSMSEnrollmentResponse);
  
  // ConfirmSMSEnrollment: Completes SMS OTP setup
  //
  // Validates SMS code and stores phone number.
  //
  // Rate limit: 10/hour per user
  // Auth required: Yes (same session as BeginSMSEnrollment)
  rpc ConfirmSMSEnrollment(ConfirmSMSEnrollmentRequest) returns (ConfirmSMSEnrollmentResponse);
  
  // ===== Email Enrollment =====
  
  // BeginEmailEnrollment: Starts Email OTP setup
  //
  // Sends verification code to email address.
  //
  // Rate limit: 5/hour per user
  // Auth required: Yes
  rpc BeginEmailEnrollment(BeginEmailEnrollmentRequest) returns (BeginEmailEnrollmentResponse);
  
  // ConfirmEmailEnrollment: Completes Email OTP setup
  //
  // Validates email code and stores email address.
  //
  // Rate limit: 10/hour per user
  // Auth required: Yes (same session as BeginEmailEnrollment)
  rpc ConfirmEmailEnrollment(ConfirmEmailEnrollmentRequest) returns (ConfirmEmailEnrollmentResponse);
  
  // ===== MFA Factor Management =====
  
  // ListMFAFactors: Lists user's enrolled MFA factors
  //
  // Shows TOTP, SMS, Email, WebAuthn factors.
  // Useful for "two-factor authentication" settings page.
  //
  // Rate limit: 20/min per user
  // Auth required: Yes
  rpc ListMFAFactors(ListMFAFactorsRequest) returns (ListMFAFactorsResponse);
  
  // RemoveMFAFactor: Removes an MFA factor
  //
  // Requires:
  //   - User authentication
  //   - At least one factor remains (if MFA required)
  //   - Re-authentication for security (recent auth)
  //
  // Rate limit: 10/min per user
  // Auth required: Yes (with re-auth)
  rpc RemoveMFAFactor(RemoveMFAFactorRequest) returns (RemoveMFAFactorResponse);
  
  // SetPrimaryMFAFactor: Designates primary MFA method
  //
  // Primary factor used by default when multiple enrolled.
  //
  // Rate limit: 20/min per user
  // Auth required: Yes
  rpc SetPrimaryMFAFactor(SetPrimaryMFAFactorRequest) returns (SetPrimaryMFAFactorResponse);
  
  // GenerateBackupCodes: Creates single-use recovery codes
  //
  // Generates 10 backup codes for MFA recovery.
  // Invalidates previous backup codes (security).
  //
  // Use when:
  //   - MFA device lost
  //   - Traveling without TOTP device
  //   - SMS not available
  //
  // Rate limit: 3/day per user (prevent abuse)
  // Auth required: Yes (with re-auth for security)
  rpc GenerateBackupCodes(GenerateBackupCodesRequest) returns (GenerateBackupCodesResponse);
}
