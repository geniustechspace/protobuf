// Client Messages - Production v1
//
// Comprehensive client metadata structures for application tracking and security.
//
// SECURITY:
//   - Do NOT include secrets, API keys, or tokens in client context
//   - User agent may contain sensitive version information
//   - Client fingerprinting raises privacy concerns
//   - Implement consent mechanisms for tracking
//
// COMPLIANCE:
//   - GDPR Article 30 (Records of processing activities)
//   - GDPR Article 13 (Information to be provided - transparency)
//   - ePrivacy Directive (Cookie/tracking consent)
//   - CCPA (Do Not Track signals)
//   - SOC 2 (Audit trail for client access)
//
// PRIVACY:
//   - PII/Quasi-identifiers: user_agent, language, locale, timezone, screen dimensions
//   - Combined data may enable user profiling and tracking
//   - Fingerprinting may persist across sessions (privacy risk)
//   - Implement data minimization: collect only necessary fields
//   - Retention: 90 days recommended, 1 year maximum
//
// STANDARDS:
//   - RFC 7231 Section 5.5.3 (User-Agent)
//   - ISO 639-1 (Language codes)
//   - ISO 3166-1 (Country codes)
//   - IANA Time Zone Database

syntax = "proto3";

package geniustechspace.datastructure.v1.client;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";
import "proto/datastructure/v1/client/enums.proto";

option go_package = "github.com/geniustechspace/protobuf/gen/go/datastructure/v1/client;clientv1";
option java_multiple_files = true;
option java_package = "space.geniustech.datastructure.v1.client";
option csharp_namespace = "GeniusTechSpace.Datastructure.V1.Client";

// ClientContext contains comprehensive client application metadata
//
// PURPOSE:
//   - Client identification for security and analytics
//   - Platform detection for feature compatibility
//   - Capability detection for adaptive UX
//   - Audit trail for access patterns
//
// SECURITY:
//   - client_id used for rate limiting and abuse detection
//   - Trust level determines access permissions
//   - Attestation validates client authenticity
//
// PRIVACY WARNING:
//   This message contains quasi-identifiers that combined may enable user tracking.
//   Implement proper consent mechanisms and data minimization.
message ClientContext {
  reserved 15 to 20, 35 to 40;

  // ========== CLIENT IDENTIFICATION ==========
  // SECURITY: Used for rate limiting and abuse detection
  
  // Unique client identifier (OAuth 2.0 client_id or generated UUID)
  string client_id = 1 [(buf.validate.field).string = {
    min_len: 1
    max_len: 128
  }];
  
  // Human-readable client name (e.g., "My App", "Chrome Browser")
  string client_name = 2 [(buf.validate.field).string = {
    max_len: 100
    ignore_empty: true
  }];
  
  // Client application version (semver recommended: 1.2.3)
  string client_version = 3 [(buf.validate.field).string = {
    max_len: 50
    ignore_empty: true
  }];
  
  // Build number or commit hash (for debugging)
  string build_number = 4 [(buf.validate.field).string = {
    max_len: 100
    ignore_empty: true
  }];
  
  // Full user agent string (RFC 7231 Section 5.5.3)
  // PRIVACY: Contains browser/OS version info (quasi-identifier)
  // SECURITY: Parse carefully to prevent injection attacks
  string user_agent = 5 [(buf.validate.field).string = {
    max_len: 2000  // Typical max user agent length
    ignore_empty: true
  }];
  
  // ========== CLIENT TYPE & PLATFORM ==========
  
  // Client type (web, mobile, desktop, IoT, service)
  // Used for platform-specific features and rate limiting
  ClientType client_type = 6;
  
  // Application platform (iOS, Android, Windows, Linux, Web)
  ClientPlatform platform = 7;
  
  // Platform OS version (e.g., "17.0", "14", "11")
  string platform_version = 8 [(buf.validate.field).string = {
    max_len: 50
    ignore_empty: true
  }];
  
  // ========== APPLICATION DETAILS ==========
  
  // Application bundle/package ID (e.g., "com.example.app", "org.company.service")
  // SECURITY: Validate against registered client IDs for official apps
  string app_id = 9 [(buf.validate.field).string = {
    max_len: 255
    pattern: "^[a-z0-9._-]+$"  // Typical package ID format
    ignore_empty: true
  }];
  
  // Application display name
  string app_name = 10 [(buf.validate.field).string = {
    max_len: 100
    ignore_empty: true
  }];
  
  // Application version (semver recommended)
  string app_version = 11 [(buf.validate.field).string = {
    max_len: 50
    ignore_empty: true
  }];

  // Application rendering engine (Blink, WebKit, Gecko)
  RenderingEngine rendering_engine = 14;
  
  // ========== TRUST & VERIFICATION ==========
  // SECURITY: Used for risk-based authentication and authorization
  
  // Client trust level (untrusted, known, trusted, verified, first-party, managed)
  // Determines access permissions and rate limits
  ClientTrustLevel trust_level = 21;
  
  // Client signature/attestation verified
  // iOS: DeviceCheck, Android: SafetyNet/Play Integrity
  bool verified = 22;
  
  // Timestamp of last verification
  google.protobuf.Timestamp verified_at = 23;
  
  // Platform attestation token (base64 encoded JWT or binary)
  // SECURITY: Validate server-side, never trust client-provided values
  string attestation = 24 [(buf.validate.field).string = {
    max_len: 10240  // 10KB max for attestation
    ignore_empty: true
  }];
  
  // ========== CAPABILITIES & FEATURES ==========
  // Used for feature detection and progressive enhancement
  
  // Client hardware/software capabilities
  // PRIVACY: Capability list can be used for fingerprinting
  repeated ClientCapability capabilities = 25 [(buf.validate.field).repeated.max_items = 50];
  
  // Feature flags enabled for this client
  // Used for A/B testing and gradual rollouts
  map<string, bool> feature_flags = 26;
  
  // ========== SDK & FRAMEWORK INFO ==========
  
  // SDK version used by client (e.g., "1.2.3")
  string sdk_version = 27 [(buf.validate.field).string = {
    max_len: 50
    ignore_empty: true
  }];
  
  // Development framework (React, Flutter, React Native, etc.)
  Framework framework = 28;
  
  // Framework version (e.g., "18.2.0" for React)
  string framework_version = 29 [(buf.validate.field).string = {
    max_len: 50
    ignore_empty: true
  }];
  
  // ========== LANGUAGE & LOCALE ==========
  // PRIVACY: Quasi-identifier - combined with other data may enable tracking
  
  // Full locale with country (RFC 5646: "en-US", "fr-FR", "es-MX")
  string locale = 30 [(buf.validate.field).string = {
    max_len: 35  // RFC 5646 max length
    pattern: "^[a-z]{2}(-[A-Z]{2})?(-[a-z]+)?$"
    ignore_empty: true
  }];
  
  // Primary language (ISO 639-1 two-letter code: "en", "fr", "es")
  string language = 31 [(buf.validate.field).string = {
    len: 2  // ISO 639-1 is always 2 characters
    pattern: "^[a-z]{2}$"
    ignore_empty: true
  }];
  
  // IANA timezone (e.g., "America/New_York", "Europe/Paris")
  // PRIVACY: Timezone reveals approximate geographic location
  string timezone = 32 [(buf.validate.field).string = {
    max_len: 100
    ignore_empty: true
  }];
  
  // UI theme preference (light, dark, auto)
  // Used for theme selection and accessibility
  // NOTE: This is a client/user preference, not device hardware
  ColorScheme theme = 33;
  
  // ========== INSTALLATION & LIFECYCLE ==========
  
  // Application installation timestamp
  google.protobuf.Timestamp installed_at = 34;
  
  // Last application update timestamp
  google.protobuf.Timestamp last_updated_at = 41;
  
  // Total app launches (for engagement metrics)
  int64 launch_count = 42 [(buf.validate.field).int64 = {
    gte: 0
    ignore_empty: true
  }];
  
  // ========== ADDITIONAL METADATA ==========
  // Flexible key-value storage for custom client properties
  // SECURITY: Validate and sanitize all metadata values
  map<string, string> metadata = 43;
}

// ClientFingerprint for unique client identification
//
// PURPOSE:
//   - Fraud detection and bot prevention
//   - Device tracking across sessions
//   - Risk assessment for authentication
//
// ⚠️ PRIVACY WARNING:
//   Client fingerprinting is a privacy-invasive technique that can track users
//   across sessions even without cookies. Use responsibly and ethically.
//
// COMPLIANCE:
//   - GDPR: Requires explicit consent for fingerprinting
//   - ePrivacy Directive: Tracking requires user consent
//   - CCPA: Users must be able to opt-out of tracking
//   - Browser vendors (Safari, Firefox) actively block fingerprinting
//
// ETHICS:
//   - Inform users about fingerprinting in privacy policy
//   - Provide opt-out mechanism
//   - Use only for security purposes (fraud, bot detection)
//   - Do NOT use for advertising or cross-site tracking
//   - Respect Do Not Track (DNT) signals
//
// SECURITY:
//   - Fingerprints can be spoofed - do not rely solely for authentication
//   - Use as one signal in multi-factor risk assessment
//   - Hash fingerprints before storage (prevent reverse engineering)
message ClientFingerprint {
  reserved 10 to 20;

  // ========== FINGERPRINT IDENTIFIER ==========

  // Fingerprint hash (SHA-256 of all components)
  // SECURITY: Store only hash, not raw fingerprint data
  string fingerprint_hash = 1 [(buf.validate.field).string = {
    len: 64  // SHA-256 hex = 64 characters
    pattern: "^[a-f0-9]{64}$"
  }];

  // ========== FINGERPRINT COMPONENTS ==========
  // PRIVACY: Each component reveals information about user's device

  // User agent string (browser identification)
  string user_agent = 2 [(buf.validate.field).string = {
    max_len: 2000
    ignore_empty: true
  }];

  // Canvas fingerprint (unique rendering characteristics)
  // Technique: Render text/graphics, hash pixel data
  string canvas_fingerprint = 3 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // WebGL fingerprint (GPU rendering characteristics)
  // Technique: Query WebGL parameters, hash result
  string webgl_fingerprint = 4 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // Audio fingerprint (audio context characteristics)
  // Technique: Generate audio signal, analyze waveform
  string audio_fingerprint = 5 [(buf.validate.field).string = {
    max_len: 128
    ignore_empty: true
  }];

  // Installed fonts list (font enumeration)
  // PRIVACY: Font list highly unique, strong fingerprint signal
  repeated string fonts = 6 [(buf.validate.field).repeated.max_items = 500];

  // Browser plugins list (navigator.plugins)
  // Note: Most browsers now restrict plugin enumeration
  repeated string plugins = 7 [(buf.validate.field).repeated.max_items = 50];

  // ========== BROWSER/ENVIRONMENT DETAILS ==========

  // GPU vendor (e.g., "NVIDIA Corporation")
  string vendor = 8 [(buf.validate.field).string = {
    max_len: 100
    ignore_empty: true
  }];

  // GPU renderer (e.g., "ANGLE (NVIDIA GeForce GTX 1080)")
  // PRIVACY: Reveals specific GPU model
  string renderer = 9 [(buf.validate.field).string = {
    max_len: 200
    ignore_empty: true
  }];

  // ========== TIMESTAMPS ==========

  // Fingerprint generation timestamp
  google.protobuf.Timestamp generated_at = 21;

  // Fingerprint expiration (recommend 90 days)
  // After expiration, regenerate fingerprint
  google.protobuf.Timestamp expires_at = 22;

  // ========== CONFIDENCE & QUALITY ==========

  // Confidence score (0.0 - 1.0)
  // High confidence = more unique signals collected
  float confidence = 23 [(buf.validate.field).float = {
    gte: 0.0
    lte: 1.0
  }];

  // ========== ADDITIONAL SIGNALS ==========
  // Other fingerprinting signals (screen resolution, timezone, etc.)
  // PRIVACY: Limit signal collection to what's necessary
  map<string, string> signals = 24;
}
