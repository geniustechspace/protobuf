// Access Policy Domain - Service Definition
//
// Defines the gRPC service interface for role-based and attribute-based
// access control management.
//
// PURPOSE: API for managing roles, permissions, and policy evaluation
// COMPLIANCE: SOC 2 CC6.1, CC6.2 (Access controls), ISO 27001 A.9.2, A.9.4
// AUTHENTICATION: All RPCs require valid authentication token
// AUTHORIZATION: Most operations require 'access_policy:admin' permission

syntax = "proto3";

package access_policy.v1;

import "access_policy/v1/requests.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.AccessPolicy.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/access_policy/v1;accesspolicyv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.accesspolicy.v1";

// AccessPolicyService provides role-based and attribute-based access control.
//
// PURPOSE: Centralized authorization service for multi-tenant applications
// COMPLIANCE: SOC 2 CC6.1, CC6.2 (Access controls), ISO 27001 A.9.2, A.9.4
//             NIST SP 800-53 AC-2 (Account Management), AC-3 (Access Enforcement)
// AUTHENTICATION: All RPCs require valid authentication token
// AUTHORIZATION: Requires 'access_policy:admin' permission unless noted otherwise
// AUDIT: All operations logged with user, timestamp, tenant, and changes
//
// SECURITY CONSIDERATIONS:
//   - Tenant isolation enforced on all operations
//   - System roles cannot be modified or deleted
//   - CheckPermission results cached for performance (5 min TTL)
//   - Rate limiting enforced on permission checks (1000/sec per user)
service AccessPolicyService {
  // CreateRole creates a new role with specified permissions.
  //
  // AUTHORIZATION: Requires 'access_policy:admin' permission
  // COMPLIANCE: SOC 2 CC6.1 (Role creation audit)
  // AUDIT: Role creation logged with creator, tenant, permissions
  //
  // ERRORS:
  //   INVALID_ARGUMENT: Missing required fields, invalid permission IDs
  //   ALREADY_EXISTS: Role name already exists in tenant
  //   PERMISSION_DENIED: Caller lacks access_policy:admin permission
  rpc CreateRole(CreateRoleRequest) returns (CreateRoleResponse);

  // GetRole retrieves role details including assigned permissions.
  //
  // AUTHORIZATION: Requires 'access_policy:read' permission
  // PERFORMANCE: Results may be cached for 5 minutes
  //
  // ERRORS:
  //   NOT_FOUND: Role ID does not exist in tenant
  //   PERMISSION_DENIED: Caller lacks access_policy:read permission
  rpc GetRole(GetRoleRequest) returns (GetRoleResponse);

  // UpdateRole modifies role name, description, or permissions.
  //
  // AUTHORIZATION: Requires 'access_policy:admin' permission
  // COMPLIANCE: SOC 2 CC6.3 (Change management - all changes audited)
  // SECURITY: System roles (is_system_role=true) cannot be updated
  // AUDIT: All changes logged with previous/new values
  //
  // ERRORS:
  //   NOT_FOUND: Role ID does not exist
  //   INVALID_ARGUMENT: Invalid permission IDs, duplicate role name
  //   PERMISSION_DENIED: Caller lacks admin permission or role is system role
  //   FAILED_PRECONDITION: Version conflict (optimistic locking)
  rpc UpdateRole(UpdateRoleRequest) returns (UpdateRoleResponse);

  // DeleteRole removes a role (soft delete for audit retention).
  //
  // AUTHORIZATION: Requires 'access_policy:admin' permission
  // COMPLIANCE: SOC 2 CC6.2 (Access termination audit)
  // SECURITY: System roles cannot be deleted
  // BEHAVIOR: Soft delete - role retained for audit, marked as deleted
  // AUDIT: Deletion logged with reason and user
  //
  // ERRORS:
  //   NOT_FOUND: Role ID does not exist
  //   PERMISSION_DENIED: Caller lacks admin permission or role is system role
  //   FAILED_PRECONDITION: Role still assigned to active users
  rpc DeleteRole(DeleteRoleRequest) returns (DeleteRoleResponse);

  // ListRoles returns paginated list of all roles in tenant.
  //
  // AUTHORIZATION: Requires 'access_policy:read' permission
  // PERFORMANCE: Results may be cached, supports pagination for large result sets
  //
  // ERRORS:
  //   INVALID_ARGUMENT: Invalid pagination parameters
  //   PERMISSION_DENIED: Caller lacks access_policy:read permission
  rpc ListRoles(ListRolesRequest) returns (ListRolesResponse);

  // AssignRole grants a role to a user, adding role's permissions to user.
  //
  // AUTHORIZATION: Requires 'access_policy:admin' permission
  // COMPLIANCE: SOC 2 CC6.1 (User provisioning audit)
  // BEHAVIOR: Idempotent - no error if role already assigned
  // AUDIT: Assignment logged with user, role, tenant, timestamp
  //
  // ERRORS:
  //   NOT_FOUND: User or role does not exist
  //   PERMISSION_DENIED: Caller lacks access_policy:admin permission
  //   INVALID_ARGUMENT: User and role in different tenants
  rpc AssignRole(AssignRoleRequest) returns (AssignRoleResponse);

  // RevokeRole removes a role from a user, revoking role's permissions.
  //
  // AUTHORIZATION: Requires 'access_policy:admin' permission
  // COMPLIANCE: SOC 2 CC6.2 (Access revocation audit)
  // BEHAVIOR: Idempotent - no error if role not assigned
  // AUDIT: Revocation logged with user, role, tenant, timestamp
  //
  // ERRORS:
  //   NOT_FOUND: User or role does not exist
  //   PERMISSION_DENIED: Caller lacks access_policy:admin permission
  rpc RevokeRole(RevokeRoleRequest) returns (RevokeRoleResponse);

  // CheckPermission evaluates if user has permission for resource/action with context.
  //
  // PURPOSE: Authorization check for API gateway and service-to-service auth
  // AUTHORIZATION: Any authenticated user can check permissions
  // PERFORMANCE: HIGH-FREQUENCY operation
  //   - Results cached for 5 minutes per user/resource/action combination
  //   - Rate limit: 1000 requests/second per user
  //   - Average latency: <10ms (cached), <50ms (uncached)
  //
  // EVALUATION LOGIC:
  //   1. Check for DENY policies matching request → Deny if any match
  //   2. Check for ALLOW policies matching request → Allow if any match
  //   3. Default deny if no policies match
  //
  // USE CASES:
  //   - API gateway authorization before routing requests
  //   - UI rendering (show/hide buttons based on permissions)
  //   - Service-to-service authorization checks
  //
  // ERRORS:
  //   NOT_FOUND: User does not exist
  //   PERMISSION_DENIED: CheckPermission blocked by rate limit
  //   RESOURCE_EXHAUSTED: Rate limit exceeded (429)
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);
}
