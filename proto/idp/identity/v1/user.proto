// DOMAIN: Identity Provider - User Entity
// COMPLIANCE: SOC 2 CC6.1, GDPR Article 5, ISO 27001 A.9.2
// SECURITY: Authentication required, tenant isolation enforced
// PII: Contains user personal data

syntax = "proto3";

package geniustechspace.idp.identity.v1;

import "buf/validate/validate.proto";
import "core/metadata/v1/metadata.proto";
import "google/protobuf/timestamp.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Idp.Identity.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/idp/identity/v1;idpidentityv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.idp.identity.v1";

// User represents a user account entity.
// PII: Yes - contains personal identifiers and data
// COMPLIANCE: GDPR Article 5 (data minimization), Article 25 (privacy by design)
message User {
  // User ID. REQUIRED.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string id = 1 [(buf.validate.field).string.min_len = 1];

  // Tenant ID. REQUIRED.
  string tenant_id = 2 [(buf.validate.field).string.min_len = 1];

  // Username. OPTIONAL.
  // Unique within tenant. For login purposes.
  // PII: Possibly - may be personal identifier
  string username = 3 [(buf.validate.field).string = {
    min_len: 3
    max_len: 64
    pattern: "^[a-zA-Z0-9_-]+$"
  }];

  // Email. REQUIRED.
  // PII: Yes - GDPR Article 4(1) personal identifier
  // ENCRYPTION: Required at rest
  // VALIDATION: RFC 5322 email format
  string email = 4 [(buf.validate.field).string.email = true];

  // Email verified. REQUIRED.
  bool email_verified = 5;

  // Email verified at. OPTIONAL.
  google.protobuf.Timestamp email_verified_at = 6;

  // Phone number. OPTIONAL.
  // PII: Yes - GDPR Article 4(1) personal identifier
  // ENCRYPTION: Required at rest
  // VALIDATION: E.164 format
  string phone_number = 7 [(buf.validate.field).string.pattern = "^\\+[1-9]\\d{1,14}$"];

  // Phone verified. OPTIONAL.
  bool phone_verified = 8;

  // Phone verified at. OPTIONAL.
  google.protobuf.Timestamp phone_verified_at = 9;

  // Status. REQUIRED.
  UserStatus status = 10 [(buf.validate.field).enum.defined_only = true];

  // External ID. OPTIONAL.
  // External system identifier for federation.
  string external_id = 11;

  // External provider. OPTIONAL.
  // Identity provider for federated identity.
  string external_provider = 12;

  // Organization IDs. OPTIONAL.
  // Organizations this user belongs to.
  repeated string organization_ids = 13;

  // Group IDs. OPTIONAL.
  // Groups this user is a member of.
  repeated string group_ids = 14;

  // Primary organization ID. OPTIONAL.
  string primary_organization_id = 15;

  // Last login at. OPTIONAL.
  google.protobuf.Timestamp last_login_at = 16;

  // Last activity at. OPTIONAL.
  google.protobuf.Timestamp last_activity_at = 17;

  // Password last changed at. OPTIONAL.
  google.protobuf.Timestamp password_changed_at = 18;

  // MFA enabled. REQUIRED.
  bool mfa_enabled = 19;

  // MFA methods. OPTIONAL.
  // Enrolled MFA methods.
  repeated string mfa_methods = 20;

  // Locked until. OPTIONAL.
  // If account is temporarily locked.
  google.protobuf.Timestamp locked_until = 21;

  // Failed login attempts. OPTIONAL.
  int32 failed_login_attempts = 22;

  // Tags. OPTIONAL.
  // Custom tags for categorization.
  repeated string tags = 23;

  // Metadata. OPTIONAL.
  core.metadata.v1.Metadata metadata = 24;
}

// UserStatus represents user account status.
enum UserStatus {
  USER_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1; // Active account
  INACTIVE = 2; // Inactive but can be reactivated
  SUSPENDED = 3; // Temporarily suspended
  LOCKED = 4; // Locked due to security concern
  DELETED = 5; // Soft deleted
  PENDING_VERIFICATION = 6; // Awaiting email/phone verification
  PENDING_APPROVAL = 7; // Awaiting admin approval
  EXPIRED = 8; // Account expired
  reserved 9 to 30;
}

// CreateUserRequest creates new user account.
// AUTHENTICATION: Required
// AUTHORIZATION: Requires 'users:create' permission
message CreateUserRequest {
  // Tenant ID. REQUIRED.
  string tenant_id = 1 [(buf.validate.field).string.min_len = 1];

  // Username. OPTIONAL.
  // PII: Possibly - may be personal identifier
  string username = 2;

  // Email. REQUIRED.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string email = 3 [(buf.validate.field).string.email = true];

  // Phone number. OPTIONAL.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string phone_number = 4;

  // Password. OPTIONAL.
  // If provided, user can login immediately.
  // SECURITY: Never logged, hashed with bcrypt/argon2id
  string password = 5 [(buf.validate.field).string = {
    min_len: 8
    max_len: 128
  }];

  // External ID. OPTIONAL.
  string external_id = 6;

  // External provider. OPTIONAL.
  string external_provider = 7;

  // Organization IDs. OPTIONAL.
  repeated string organization_ids = 8;

  // Group IDs. OPTIONAL.
  repeated string group_ids = 9;

  // Send verification email. OPTIONAL.
  // Whether to send email verification.
  bool send_verification_email = 10;

  // Tags. OPTIONAL.
  repeated string tags = 11;
}

// CreateUserResponse returns created user.
message CreateUserResponse {
  // Success. REQUIRED.
  bool success = 1;

  // User. OPTIONAL.
  User user = 2;

  // Message. OPTIONAL.
  string message = 3;
}

// GetUserRequest retrieves user by ID.
// AUTHENTICATION: Required
// AUTHORIZATION: Self or 'users:read' permission
message GetUserRequest {
  // Tenant ID. REQUIRED.
  string tenant_id = 1 [(buf.validate.field).string.min_len = 1];

  // User ID. REQUIRED.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string user_id = 2 [(buf.validate.field).string.min_len = 1];
}

// GetUserResponse returns user.
message GetUserResponse {
  // User. REQUIRED.
  User user = 1;
}

// UpdateUserRequest updates user account.
// AUTHENTICATION: Required
// AUTHORIZATION: Self or 'users:update' permission
message UpdateUserRequest {
  // Tenant ID. REQUIRED.
  string tenant_id = 1 [(buf.validate.field).string.min_len = 1];

  // User ID. REQUIRED.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string user_id = 2 [(buf.validate.field).string.min_len = 1];

  // Username. OPTIONAL.
  string username = 3;

  // Email. OPTIONAL.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string email = 4 [(buf.validate.field).string.email = true];

  // Phone number. OPTIONAL.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string phone_number = 5;

  // Status. OPTIONAL.
  UserStatus status = 6;

  // Organization IDs. OPTIONAL.
  repeated string organization_ids = 7;

  // Group IDs. OPTIONAL.
  repeated string group_ids = 8;

  // Tags. OPTIONAL.
  repeated string tags = 9;
}

// UpdateUserResponse returns updated user.
message UpdateUserResponse {
  // Success. REQUIRED.
  bool success = 1;

  // User. OPTIONAL.
  User user = 2;

  // Message. OPTIONAL.
  string message = 3;
}

// DeleteUserRequest deletes (soft delete) user account.
// AUTHENTICATION: Required
// AUTHORIZATION: Requires 'users:delete' permission
message DeleteUserRequest {
  // Tenant ID. REQUIRED.
  string tenant_id = 1 [(buf.validate.field).string.min_len = 1];

  // User ID. REQUIRED.
  // PII: Yes - GDPR Article 4(1) personal identifier
  string user_id = 2 [(buf.validate.field).string.min_len = 1];

  // Hard delete. OPTIONAL.
  // Permanently delete instead of soft delete.
  // COMPLIANCE: GDPR Article 17 (Right to erasure)
  bool hard_delete = 3;
}

// DeleteUserResponse confirms user deletion.
message DeleteUserResponse {
  // Success. REQUIRED.
  bool success = 1;

  // Message. OPTIONAL.
  string message = 2;
}

// ListUsersRequest lists users.
// AUTHENTICATION: Required
// AUTHORIZATION: Requires 'users:list' permission
message ListUsersRequest {
  // Tenant ID. REQUIRED.
  string tenant_id = 1 [(buf.validate.field).string.min_len = 1];

  // Organization ID. OPTIONAL.
  // Filter by organization.
  string organization_id = 2;

  // Group ID. OPTIONAL.
  // Filter by group.
  string group_id = 3;

  // Status. OPTIONAL.
  // Filter by status.
  UserStatus status = 4;

  // Search query. OPTIONAL.
  // Search by email, username, name.
  string query = 5;

  // Page size. OPTIONAL.
  int32 page_size = 6 [(buf.validate.field).int32 = {
    gte: 1
    lte: 100
  }];

  // Page token. OPTIONAL.
  string page_token = 7;
}

// ListUsersResponse returns paginated users.
message ListUsersResponse {
  // Users. REQUIRED.
  repeated User users = 1;

  // Next page token. OPTIONAL.
  string next_page_token = 2;

  // Total count. OPTIONAL.
  int32 total_count = 3;
}
