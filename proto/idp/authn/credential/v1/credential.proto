// DOMAIN: Authentication - Credential Aggregate Root
// COMPLIANCE: NIST 800-63B, SOC 2 CC6.1
// SECURITY: Credentials never stored in plaintext, always hashed
// DDD: Aggregate Root - controls credential lifecycle

syntax = "proto3";

package geniustechspace.idp.authn.credential.v1;

import "buf/validate/validate.proto";
import "core/metadata/v1/metadata.proto";
import "google/protobuf/timestamp.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Idp.Authn.Credential.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/idp/authn/credential/v1;idpauthncredentialv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.idp.authn.credential.v1";

// Credential aggregate root - represents authentication credential.
// INVARIANTS:
// - One primary credential per user per type
// - Password must meet complexity requirements
// - WebAuthn credentials must be FIDO2 certified
// - Credentials expire per policy
message Credential {
  // Credential ID. Immutable.
  string id = 1 [(buf.validate.field).string.max_len = 512];

  // Tenant path. Immutable.
  string tenant_path = 2 [(buf.validate.field).string.max_len = 512];

  // User ID. Immutable.
  string user_id = 3 [(buf.validate.field).string.max_len = 512];

  // Credential type.
  CredentialType type = 4 [(buf.validate.field).enum.defined_only = true];

  // Credential status.
  CredentialStatus status = 5 [(buf.validate.field).enum.defined_only = true];

  // Credential data (type-specific).
  oneof credential_data {
    // Password credential (hashed).
    PasswordCredentialData password = 6;

    // WebAuthn credential.
    WebAuthnCredentialData webauthn = 7;

    // TOTP credential.
    TotpCredentialData totp = 8;

    // API key credential (hashed).
    ApiKeyCredentialData api_key = 9;

    // Certificate credential.
    CertificateCredentialData certificate = 10;
  }

  // Is primary credential for type.
  bool is_primary = 11;

  // Last used timestamp.
  google.protobuf.Timestamp last_used_at = 12;

  // Use count.
  int64 use_count = 13;

  // Expires at timestamp.
  google.protobuf.Timestamp expires_at = 14;

  // Created timestamp. IMMUTABLE after creation.
  // COMPLIANCE: SOC 2 CC6.3, GDPR Article 30 (audit trail)
  google.protobuf.Timestamp created_at = 15 [(buf.validate.field).required = true];

  // Last updated timestamp.
  // COMPLIANCE: SOC 2 CC6.3 (change tracking)
  google.protobuf.Timestamp updated_at = 16;

  // Deletion timestamp. If set, entity is soft deleted.
  // COMPLIANCE: GDPR Article 17, SOC 2 CC6.3 (deletion audit trail)
  // QUERY: Use "WHERE deleted_at IS NULL" for active records
  google.protobuf.Timestamp deleted_at = 17;

  // Optimistic locking version counter. Incremented on each update.
  // COMPLIANCE: SOC 2 CC6.1 (data integrity, concurrent modification protection)
  int64 version = 18;
}

// CredentialType enum.
enum CredentialType {
  CREDENTIAL_TYPE_UNSPECIFIED = 0;
  PASSWORD = 1;
  WEBAUTHN = 2;
  TOTP = 3;
  API_KEY = 4;
  CERTIFICATE = 5;
  RECOVERY_CODE = 6;
}

// CredentialStatus enum.
enum CredentialStatus {
  CREDENTIAL_STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  INACTIVE = 2;
  REVOKED = 3;
  EXPIRED = 4;
  COMPROMISED = 5;
}

// PasswordCredentialData value object.
// SECURITY: Never store plaintext password, always bcrypt/argon2id hash
message PasswordCredentialData {
  // Password hash (bcrypt/argon2id).
  // SECURITY: Never include in API responses
  string password_hash = 1;

  // Hashing algorithm (bcrypt, argon2id).
  string hash_algorithm = 2;

  // Salt (if separate from hash).
  string salt = 3;

  // Hash cost/iterations.
  int32 cost = 4;

  // Password changed at.
  google.protobuf.Timestamp changed_at = 5;

  // Force password change flag.
  bool force_change = 6;

  // Password history (hashes of previous passwords).
  repeated string password_history = 7;
}

// WebAuthnCredentialData value object.
// COMPLIANCE: WebAuthn Level 2, FIDO2 CTAP2
message WebAuthnCredentialData {
  // Credential ID (from WebAuthn).
  bytes credential_id = 1;

  // Public key (COSE format).
  bytes public_key = 2;

  // Authenticator AAGUID.
  bytes aaguid = 3;

  // Sign count (for clone detection).
  uint32 sign_count = 4;

  // Credential name (user-friendly).
  string name = 5;

  // Authenticator type (platform, cross-platform).
  string authenticator_type = 6;

  // Transports (usb, nfc, ble, internal).
  repeated string transports = 7;

  // Backup eligible flag.
  bool backup_eligible = 8;

  // Backup state flag.
  bool backup_state = 9;

  // Registered at.
  google.protobuf.Timestamp registered_at = 10;
}

// TotpCredentialData value object.
// COMPLIANCE: RFC 6238
message TotpCredentialData {
  // Secret key (base32 encoded).
  // SECURITY: Encrypted at rest
  string secret = 1;

  // Algorithm (SHA1, SHA256, SHA512).
  string algorithm = 2;

  // Digits (6, 7, 8).
  int32 digits = 3;

  // Period in seconds (30 typical).
  int32 period = 4;

  // Issuer (for QR code).
  string issuer = 5;

  // Account name (for QR code).
  string account_name = 6;

  // Enrolled at.
  google.protobuf.Timestamp enrolled_at = 7;
}

// ApiKeyCredentialData value object.
message ApiKeyCredentialData {
  // API key hash (never store plaintext).
  string key_hash = 1;

  // Key prefix (for identification, e.g., "sk_live_").
  string key_prefix = 2;

  // Key name.
  string name = 3;

  // Scopes granted.
  repeated string scopes = 4;

  // Rate limit.
  int32 rate_limit = 5;

  // Last used at.
  google.protobuf.Timestamp last_used_at = 6;
}

// CertificateCredentialData value object.
message CertificateCredentialData {
  // Certificate fingerprint (SHA-256).
  string fingerprint = 1;

  // Subject DN.
  string subject = 2;

  // Issuer DN.
  string issuer = 3;

  // Serial number.
  string serial_number = 4;

  // Not before.
  google.protobuf.Timestamp not_before = 5;

  // Not after.
  google.protobuf.Timestamp not_after = 6;

  // Certificate PEM.
  // SECURITY: Public certificate only, not private key
  string certificate_pem = 7;
}
