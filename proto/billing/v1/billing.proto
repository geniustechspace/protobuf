// Billing Domain - Subscription and Payment Management
//
// Handles subscription lifecycle, invoicing, payment methods, and billing operations
// for multi-tenant SaaS platforms with recurring revenue models.
//
// COMPLIANCE: PCI DSS (Payment card data security), SOC 2 CC6.1 (Financial controls)
//             GDPR Article 6 (Payment processing), SOC 2 CC7.2 (System monitoring)
// SECURITY: Payment card data never stored directly. Tokenization required.
//           All financial operations audited. Encryption at rest and in transit.
//           Tenant billing data strictly isolated.

syntax = "proto3";

package billing.v1;

import "core/v1/common.proto";
import "google/protobuf/timestamp.proto";

option csharp_namespace = "GeniusTechSpace.Protobuf.Billing.V1";
option go_package = "github.com/geniustechspace/protobuf/gen/go/billing/v1;billingv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.billing.v1";

// Subscription represents a tenant's active subscription to a service plan.
//
// COMPLIANCE: SOC 2 CC6.1 (Subscription access), GDPR Article 6 (Contract processing)
message Subscription {
  // Standard metadata (ID, timestamps, created_by, etc.)
  core.v1.Metadata metadata = 1;

  // Tenant ID. REQUIRED, unique subscription per tenant
  string tenant_id = 2;

  // Plan ID being subscribed to
  string plan_id = 3;

  // Current subscription status
  SubscriptionStatus status = 4;

  // Current billing period start date
  google.protobuf.Timestamp current_period_start = 5;

  // Current billing period end date
  google.protobuf.Timestamp current_period_end = 6;

  // Trial end date (if applicable)
  google.protobuf.Timestamp trial_end = 7;

  // Subscription amount per billing period
  core.v1.Money amount = 8;

  // Billing frequency
  BillingInterval billing_interval = 9;

  // Automatic renewal enabled
  bool auto_renew = 10;

  // Default payment method ID
  string payment_method_id = 11;
}

// SubscriptionStatus represents subscription lifecycle states.
//
// COMPLIANCE: SOC 2 CC6.2 (Access based on subscription status)
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_ACTIVE = 1; // Active subscription, full access
  SUBSCRIPTION_STATUS_TRIALING = 2; // Trial period, full access
  SUBSCRIPTION_STATUS_PAST_DUE = 3; // Payment failed, grace period
  SUBSCRIPTION_STATUS_CANCELED = 4; // Canceled, access revoked
  SUBSCRIPTION_STATUS_UNPAID = 5; // Payment overdue, limited access
}

// BillingInterval defines recurring payment frequencies.
enum BillingInterval {
  BILLING_INTERVAL_UNSPECIFIED = 0;
  BILLING_INTERVAL_MONTHLY = 1; // Billed monthly
  BILLING_INTERVAL_QUARTERLY = 2; // Billed quarterly
  BILLING_INTERVAL_YEARLY = 3; // Billed annually
}

// Plan represents a subscription plan with pricing and feature set.
message Plan {
  // Standard metadata (ID, timestamps, created_by, etc.)
  core.v1.Metadata metadata = 1;

  // Plan name (e.g., "Starter", "Professional", "Enterprise")
  string name = 2;

  // Plan description
  string description = 3;

  // Plan price
  core.v1.Money price = 4;

  // Billing frequency for this plan
  BillingInterval billing_interval = 5;

  // Trial period length in days (0 for no trial)
  int32 trial_days = 6;

  // Features included in plan
  PlanFeatures features = 7;

  // Plan available for new subscriptions
  bool is_active = 8;
}

// PlanFeatures defines capabilities and limits included in a subscription plan.
message PlanFeatures {
  // Maximum users allowed (0 = unlimited)
  int32 max_users = 1;

  // Maximum storage in GB (0 = unlimited)
  int32 max_storage_gb = 2;

  // API access enabled
  bool api_access = 3;

  // Priority support included
  bool priority_support = 4;

  // Custom branding allowed
  bool custom_branding = 5;

  // Single Sign-On (SSO) enabled
  bool sso = 6;

  // Additional features (key-value pairs)
  map<string, string> additional_features = 7;
}

// Invoice represents a billing invoice for services rendered.
//
// COMPLIANCE: SOC 2 CC7.2 (Financial reporting), Tax regulations
message Invoice {
  // Standard metadata (ID, timestamps, created_by, etc.)
  core.v1.Metadata metadata = 1;

  // Tenant ID. REQUIRED
  string tenant_id = 2;

  // Associated subscription ID
  string subscription_id = 3;

  // Human-readable invoice number (e.g., "INV-2025-0001")
  string invoice_number = 4;

  // Invoice payment status
  InvoiceStatus status = 5;

  // Subtotal before tax
  core.v1.Money subtotal = 6;

  // Tax amount
  core.v1.Money tax = 7;

  // Total amount due
  core.v1.Money total = 8;

  // Payment due date
  google.protobuf.Timestamp due_date = 9;

  // Payment completion timestamp
  google.protobuf.Timestamp paid_at = 10;

  // Invoice line items
  repeated InvoiceLineItem line_items = 11;
}

// InvoiceStatus represents invoice payment states.
enum InvoiceStatus {
  INVOICE_STATUS_UNSPECIFIED = 0;
  INVOICE_STATUS_DRAFT = 1; // Draft, not finalized
  INVOICE_STATUS_OPEN = 2; // Sent, awaiting payment
  INVOICE_STATUS_PAID = 3; // Paid in full
  INVOICE_STATUS_VOID = 4; // Voided/canceled
  INVOICE_STATUS_UNCOLLECTIBLE = 5; // Written off as uncollectible
}

// InvoiceLineItem represents a single charge on an invoice.
message InvoiceLineItem {
  // Line item description
  string description = 1;

  // Quantity
  int32 quantity = 2;

  // Unit price
  core.v1.Money unit_price = 3;

  // Total amount (quantity * unit_price)
  core.v1.Money amount = 4;
}

// PaymentMethod represents a stored payment method (tokenized).
//
// COMPLIANCE: PCI DSS Level 1 (No card data stored, tokens only)
// SECURITY: Only last 4 digits stored. Full card data never persisted.
message PaymentMethod {
  // Standard metadata (ID, timestamps, created_by, etc.)
  core.v1.Metadata metadata = 1;

  // Tenant ID. REQUIRED
  string tenant_id = 2;

  // Payment method type
  PaymentMethodType type = 3;

  // Last 4 digits (for display). PII: Partial card data
  string last4 = 4;

  // Card brand (e.g., "Visa", "Mastercard")
  string brand = 5;

  // Expiration month (1-12)
  int32 exp_month = 6;

  // Expiration year (4 digits)
  int32 exp_year = 7;

  // Default payment method for tenant
  bool is_default = 8;
}

// PaymentMethodType defines supported payment method types.
//
// COMPLIANCE: PCI DSS (Card processing), ACH regulations (Bank accounts)
enum PaymentMethodType {
  PAYMENT_METHOD_TYPE_UNSPECIFIED = 0;
  PAYMENT_METHOD_TYPE_CARD = 1; // Credit/debit card (PCI DSS)
  PAYMENT_METHOD_TYPE_BANK_ACCOUNT = 2; // ACH/direct debit
  PAYMENT_METHOD_TYPE_PAYPAL = 3; // PayPal integration
}

// CreateSubscriptionRequest for creating a new subscription
message CreateSubscriptionRequest {
  string tenant_id = 1;
  string plan_id = 2;
  string payment_method_id = 3;
  bool trial = 4;
}

// CreateSubscriptionResponse returns the created subscription
message CreateSubscriptionResponse {
  Subscription subscription = 1;
}

// GetSubscriptionRequest for retrieving a subscription
message GetSubscriptionRequest {
  string tenant_id = 1;
  string subscription_id = 2;
}

// GetSubscriptionResponse returns the requested subscription
message GetSubscriptionResponse {
  Subscription subscription = 1;
}

// UpdateSubscriptionRequest for updating a subscription
message UpdateSubscriptionRequest {
  string tenant_id = 1;
  string subscription_id = 2;
  string plan_id = 3;
}

// UpdateSubscriptionResponse returns the updated subscription
message UpdateSubscriptionResponse {
  Subscription subscription = 1;
}

// CancelSubscriptionRequest for canceling a subscription
message CancelSubscriptionRequest {
  string tenant_id = 1;
  string subscription_id = 2;
  bool immediate = 3;
}

// CancelSubscriptionResponse confirms cancellation
message CancelSubscriptionResponse {
  bool success = 1;
  google.protobuf.Timestamp cancellation_effective_date = 2;
}

// ListInvoicesRequest for listing invoices
message ListInvoicesRequest {
  string tenant_id = 1;
  core.v1.PaginationRequest pagination = 2;
  InvoiceStatus status = 3;
}

// ListInvoicesResponse returns a list of invoices
message ListInvoicesResponse {
  repeated Invoice invoices = 1;
  core.v1.PaginationResponse pagination = 2;
}

// GetInvoiceRequest for retrieving an invoice
message GetInvoiceRequest {
  string tenant_id = 1;
  string invoice_id = 2;
}

// GetInvoiceResponse returns the requested invoice
message GetInvoiceResponse {
  Invoice invoice = 1;
}

// PayInvoiceRequest for paying an invoice
message PayInvoiceRequest {
  string tenant_id = 1;
  string invoice_id = 2;
  string payment_method_id = 3;
}

// PayInvoiceResponse confirms payment
message PayInvoiceResponse {
  bool success = 1;
  Invoice invoice = 2;
}

// AddPaymentMethodRequest for adding a payment method
message AddPaymentMethodRequest {
  string tenant_id = 1;
  string token = 2;
  bool set_as_default = 3;
}

// AddPaymentMethodResponse returns the added payment method
message AddPaymentMethodResponse {
  PaymentMethod payment_method = 1;
}

// ListPaymentMethodsRequest for listing payment methods
message ListPaymentMethodsRequest {
  string tenant_id = 1;
}

// ListPaymentMethodsResponse returns a list of payment methods
message ListPaymentMethodsResponse {
  repeated PaymentMethod payment_methods = 1;
}

// BillingService provides subscription and payment management operations.
//
// COMPLIANCE: PCI DSS Level 1, SOC 2 CC6.1, CC7.2 (Financial controls)
// AUTHENTICATION: All RPCs require valid authentication token
// AUTHORIZATION: Requires 'billing:admin' or tenant owner permission
// SECURITY: All payment operations use TLS 1.2+. Card data tokenized.
//           Rate limiting: 100 req/min per tenant for payment operations
service BillingService {
  // CreateSubscription starts a new subscription. Requires 'billing:admin'.
  // COMPLIANCE: SOC 2 CC6.1 (Subscription provisioning)
  rpc CreateSubscription(CreateSubscriptionRequest) returns (CreateSubscriptionResponse);

  // GetSubscription retrieves subscription details. Requires 'billing:read'.
  rpc GetSubscription(GetSubscriptionRequest) returns (GetSubscriptionResponse);

  // UpdateSubscription modifies plan or settings. Prorates charges. Requires 'billing:admin'.
  // COMPLIANCE: SOC 2 CC6.3 (Change management)
  rpc UpdateSubscription(UpdateSubscriptionRequest) returns (UpdateSubscriptionResponse);

  // CancelSubscription terminates subscription. Requires 'billing:admin'.
  // COMPLIANCE: SOC 2 CC6.2 (Access termination), GDPR Article 17 (Right to erasure)
  rpc CancelSubscription(CancelSubscriptionRequest) returns (CancelSubscriptionResponse);

  // ListInvoices retrieves invoice history. Requires 'billing:read'.
  rpc ListInvoices(ListInvoicesRequest) returns (ListInvoicesResponse);

  // GetInvoice retrieves invoice details. Requires 'billing:read'.
  rpc GetInvoice(GetInvoiceRequest) returns (GetInvoiceResponse);

  // PayInvoice processes payment for open invoice. Requires 'billing:admin'.
  // COMPLIANCE: PCI DSS (Secure payment processing)
  // SECURITY: Rate limit: 10 attempts/hour per tenant
  rpc PayInvoice(PayInvoiceRequest) returns (PayInvoiceResponse);

  // AddPaymentMethod stores tokenized payment method. Requires 'billing:admin'.
  // COMPLIANCE: PCI DSS Level 1 (Tokenization required)
  // SECURITY: Card data must be pre-tokenized by payment gateway
  rpc AddPaymentMethod(AddPaymentMethodRequest) returns (AddPaymentMethodResponse);

  // ListPaymentMethods retrieves stored payment methods. Requires 'billing:read'.
  rpc ListPaymentMethods(ListPaymentMethodsRequest) returns (ListPaymentMethodsResponse);
}
