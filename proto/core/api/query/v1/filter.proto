// Core API Query - Filter Module
//
// Storage-agnostic filtering for all query operations.
// Compatible with SQL, NoSQL, document stores, search engines, etc.

syntax = "proto3";

package geniustechspace.core.api.query.v1;

import "buf/validate/validate.proto";

option go_package = "github.com/geniustechspace/protobuf/gen/go/core/api/query/v1;queryv1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.protobuf.core.api.query.v1";

// FilterOperator defines all comparison operations.
enum FilterOperator {
  FILTER_OPERATOR_UNSPECIFIED = 0;

  // Equality
  EQ = 1; // Equal
  NE = 2; // Not equal

  // Comparison
  GT = 3; // Greater than
  GTE = 4; // Greater than or equal
  LT = 5; // Less than
  LTE = 6; // Less than or equal

  // Collection
  IN = 7; // In list
  NOT_IN = 8; // Not in list

  // String matching
  CONTAINS = 9; // Contains substring
  NOT_CONTAINS = 10; // Does not contain
  STARTS_WITH = 11; // Starts with prefix
  ENDS_WITH = 12; // Ends with suffix
  MATCHES = 13; // Regex match
  ILIKE = 14; // Case-insensitive like

  // Null checks
  IS_NULL = 15; // Is null/unset
  IS_NOT_NULL = 16; // Is not null

  // Range
  BETWEEN = 17; // Between two values

  // Array operations
  ARRAY_CONTAINS = 18; // Array contains value
  ARRAY_CONTAINS_ANY = 19; // Array contains any of values
  ARRAY_CONTAINS_ALL = 20; // Array contains all values

  // Geospatial
  GEO_NEAR = 21; // Near geographic point
  GEO_WITHIN = 22; // Within geographic area
  GEO_INTERSECTS = 23; // Intersects geographic shape

  // Full-text search
  TEXT_SEARCH = 24; // Full-text search match

  // Existence
  EXISTS = 25; // Field exists
}

// Filter provides composable filtering with type-safe values.
//
// Use 'value' for scalar operators (EQ, GT, CONTAINS, etc.)
// Use 'values' for collection operators (IN, NOT_IN, ARRAY_CONTAINS_ANY, etc.)
//
// Server converts values to appropriate types based on schema and operator.
// NOTE: Set only one of 'value' or 'values' based on operator type.
message Filter {
  option (buf.validate.message).cel = {
    id: "value_xor_values"
    message: "Only one of 'value' or 'values' can be set, not both"
    expression: "!(this.value != '' && this.values.size() > 0)"
  };

  // Field path with dot notation for nested fields.
  // Examples: "status", "user.email", "orders[].total"
  // Supports relation auto-detection: "user.status" â†’ auto-joins user table
  string field = 1 [(buf.validate.field).string.max_len = 256];

  // Comparison operator
  FilterOperator op = 2;

  // Single value for scalar operators (EQ, NE, GT, CONTAINS, etc.)
  // Mutually exclusive with 'values' - set only one.
  string value = 3 [(buf.validate.field).string.max_len = 4096];

  // Multiple values for collection operators (IN, NOT_IN, ARRAY_*, BETWEEN, etc.)
  // Mutually exclusive with 'value' - set only one.
  repeated string values = 4 [(buf.validate.field).repeated = {
    min_items: 1
    max_items: 1000
    items: {
      string: {
        min_len: 1
        max_len: 500
      }
    }
  }];

  reserved 5 to 9;

  // Combine filters with AND logic
  repeated Filter and = 10 [(buf.validate.field).repeated.max_items = 50];

  // Combine filters with OR logic
  repeated Filter or = 11 [(buf.validate.field).repeated.max_items = 50];

  reserved 12 to 19;
}
